(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&l(i)}).observe(document,{childList:!0,subtree:!0});function a(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function l(o){if(o.ep)return;o.ep=!0;const r=a(o);fetch(o.href,r)}})();class O extends AudioWorkletNode{static async create(e){try{await e.audioWorklet.addModule("resonator-processor.js")}catch{}return new O(e)}constructor(e){super(e,"resonator-processor",{numberOfInputs:0,numberOfOutputs:2,outputChannelCount:[2,2],parameterData:{nbranches:4,noiseLevel:.03,noiseType:1,lfoEnabled:1,lfoRate:.1,lfoDepth:.7,lfoWave:0,rmix:1,quantize:0,exciterCutoff:4e3,exciterHP:50,rainEnabled:1,rainGain:.62,rainRate:.83,rainDurMs:61,rainSpread:.71,rainCenter:.49,rainLimbs:10,monitorExciter:0,groupEnabled:0,groupSplit:0,octaves:0,freqScale:1,freqCenter:0,decayScale:1,exciterBandQ:30}})}get nbranches(){return this.parameters.get("nbranches")}get noiseLevel(){return this.parameters.get("noiseLevel")}get noiseType(){return this.parameters.get("noiseType")}get lfoEnabled(){return this.parameters.get("lfoEnabled")}get lfoRate(){return this.parameters.get("lfoRate")}get lfoDepth(){return this.parameters.get("lfoDepth")}get lfoWave(){return this.parameters.get("lfoWave")}get rmix(){return this.parameters.get("rmix")}get quantize(){return this.parameters.get("quantize")}get exciterCutoff(){return this.parameters.get("exciterCutoff")}get exciterHP(){return this.parameters.get("exciterHP")}get groupEnabled(){return this.parameters.get("groupEnabled")}get groupSplit(){return this.parameters.get("groupSplit")}get octaves(){return this.parameters.get("octaves")}get rainEnabled(){return this.parameters.get("rainEnabled")}get rainGain(){return this.parameters.get("rainGain")}get rainRate(){return this.parameters.get("rainRate")}get rainDurMs(){return this.parameters.get("rainDurMs")}get rainSpread(){return this.parameters.get("rainSpread")}get rainCenter(){return this.parameters.get("rainCenter")}get rainLimbs(){return this.parameters.get("rainLimbs")}get monitorExciter(){return this.parameters.get("monitorExciter")}get freqScale(){return this.parameters.get("freqScale")}get freqCenter(){return this.parameters.get("freqCenter")}get decayScale(){return this.parameters.get("decayScale")}get exciterBandQ(){return this.parameters.get("exciterBandQ")}setBranchParams(e,{freq:a,decay:l,amp:o,pan:r}){this.port.postMessage({type:"setBranchParams",index:e,params:{freq:a,decay:l,amp:o,pan:r}})}setAllBranches(e){this.port.postMessage({type:"setAllBranches",branches:e})}setScale({name:e,root:a}){this.port.postMessage({type:"setScale",name:e,root:a})}}let m=null,n=null;const L=40;let q=0;const W=["noiseLevel","noiseType","lfoEnabled","lfoRate","lfoDepth","lfoWave","exciterCutoff","exciterHP","exciterBandQ","monitorExciter","rainEnabled","rainGain","rainRate","rainDurMs","rainSpread","rainCenter","rainLimbs"];let z=!1,A=null;function Q(t){return document.getElementById(t)}function pe(t,e){if(!n||!m)return;const a=m.currentTime;switch(t){case"noiseLevel":n.noiseLevel&&n.noiseLevel.setValueAtTime(parseFloat(e),a);break;case"noiseType":n.noiseType&&n.noiseType.setValueAtTime(parseInt(e,10),a);break;case"lfoEnabled":n.lfoEnabled&&n.lfoEnabled.setValueAtTime(e?1:0,a);break;case"lfoRate":n.lfoRate&&n.lfoRate.setValueAtTime(parseFloat(e),a);break;case"lfoDepth":n.lfoDepth&&n.lfoDepth.setValueAtTime(parseFloat(e),a);break;case"lfoWave":n.lfoWave&&n.lfoWave.setValueAtTime(parseInt(e,10),a);break;case"exciterCutoff":n.exciterCutoff&&n.exciterCutoff.setValueAtTime(parseFloat(e),a);break;case"exciterHP":n.exciterHP&&n.exciterHP.setValueAtTime(parseFloat(e),a);break;case"exciterBandQ":n.exciterBandQ&&n.exciterBandQ.setValueAtTime(parseFloat(e),a);break;case"monitorExciter":n.monitorExciter&&n.monitorExciter.setValueAtTime(e?1:0,a);break;case"rainEnabled":n.rainEnabled&&n.rainEnabled.setValueAtTime(e?1:0,a);break;case"rainGain":n.rainGain&&n.rainGain.setValueAtTime(parseFloat(e),a);break;case"rainRate":n.rainRate&&n.rainRate.setValueAtTime(parseFloat(e),a);break;case"rainDurMs":n.rainDurMs&&n.rainDurMs.setValueAtTime(parseFloat(e),a);break;case"rainSpread":n.rainSpread&&n.rainSpread.setValueAtTime(parseFloat(e),a);break;case"rainCenter":n.rainCenter&&n.rainCenter.setValueAtTime(parseFloat(e),a);break;case"rainLimbs":n.rainLimbs&&n.rainLimbs.setValueAtTime(parseInt(e,10),a);break}}function fe(){const t={};for(const e of W){const a=Q(e);if(!a){e==="noiseLevel"&&n&&n.noiseLevel&&(t[e]=n.noiseLevel.value);continue}a.type==="checkbox"?t[e]=!!a.checked:t[e]=a.value}return t}function P(t){if(!A)return;const e=t||fe();A.postMessage({type:"state",source:"main",state:e,partial:!!t})}function G(t,e){const a=Q(t);if(!a){pe(t,e);return}z=!0;try{if(a.type==="checkbox")a.checked=!!e,a.dispatchEvent(new Event("change",{bubbles:!0}));else{a.value=String(e);const l=a.tagName==="SELECT"?"change":"input";a.dispatchEvent(new Event(l,{bubbles:!0}))}}finally{z=!1}}function ge(){if(!A&&!(typeof BroadcastChannel>"u")){A=new BroadcastChannel("exciter-controls"),A.onmessage=t=>{const e=t.data||{};if(e.source!=="main")if(e.type==="set"&&e.id)G(e.id,e.value);else if(e.type==="setMultiple"&&e.values){const a=Object.entries(e.values);for(const[l,o]of a)G(l,o)}else e.type==="requestState"&&P()};for(const t of W){const e=Q(t);if(!e)continue;const a=()=>{if(z)return;const l=e.type==="checkbox"?!!e.checked:e.value;P({[t]:l})};e.addEventListener("input",a),e.addEventListener("change",a)}}}const re=25,ie=8e3;function _(t){const e=re,a=ie,l=Math.min(Math.max(t,e),a);return Math.log(l/e)/Math.log(a/e)}function oe(t){const e=re,a=ie,l=Math.min(Math.max(t,0),1);return e*Math.pow(a/e,l)}function M(t,e){return Math.random()*(e-t)+t}function le(t){return Math.round(t*100)/100}function se(t){return Math.max(0,Math.min(1,t))}function Z(t,e,a){return a>e?se((t-e)/(a-e)):0}function K(t,e,a){const l=se(t);return e+l*(a-e)}const ce="randomizerConfigV1",V=[{id:"rmix",label:"Mix (rmix)",kind:"float",min:0,max:1,step:.001},{id:"nbranches",label:"Branch count",kind:"int",min:1,max:L,step:1},{id:"freqScale",label:"Freq Scale",kind:"float",min:.25,max:4,step:.01},{id:"octaves",label:"Octave Transpose",kind:"int",min:-4,max:2,step:1},{id:"freqCenter",label:"Freq Center (Hz)",kind:"int",min:-2e3,max:2e3,step:1},{id:"decayScale",label:"Decay Scale",kind:"float",min:.25,max:4,step:.01},{id:"groupEnabled",label:"Group Mode",kind:"bool"},{id:"groupSplit",label:"Group Split",kind:"int",min:0,max:L,step:1},{id:"scaleRoot",label:"Scale Root",kind:"select",options:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]},{id:"scaleName",label:"Scale",kind:"select",options:["off","chromatic","major","minor","harmonicMinor","melodicMinor","dorian","phrygian","lydian","mixolydian","locrian","pentatonicMajor","pentatonicMinor","blues","wholeTone","octatonic12","octatonic21"]},{id:"noiseLevel",label:"Noise Level",kind:"float",min:0,max:.5,step:.001},{id:"noiseType",label:"Noise Type",kind:"int",min:0,max:3,step:1},{id:"lfoEnabled",label:"LFO Enable",kind:"bool"},{id:"lfoRate",label:"LFO Rate (Hz)",kind:"float",min:.1,max:20,step:.01},{id:"lfoDepth",label:"LFO Depth",kind:"float",min:0,max:1,step:.01},{id:"lfoWave",label:"LFO Wave",kind:"int",min:0,max:3,step:1},{id:"exciterCutoff",label:"Exciter LP (Hz)",kind:"int",min:50,max:2e4,step:1},{id:"exciterHP",label:"Exciter HP (Hz)",kind:"int",min:10,max:2e3,step:1},{id:"exciterBandQ",label:"Exciter Band Q",kind:"float",min:.5,max:80,step:.5},{id:"monitorExciter",label:"Monitor Exciter Only",kind:"bool"},{id:"rainEnabled",label:"Rain Enabled",kind:"bool"},{id:"rainGain",label:"Rain Gain",kind:"float",min:0,max:1,step:.01},{id:"rainRate",label:"Rain Rate (Hz)",kind:"float",min:.1,max:40,step:.01},{id:"rainDurMs",label:"Drop Duration (ms)",kind:"int",min:1,max:200,step:1},{id:"rainSpread",label:"Spread",kind:"float",min:0,max:1,step:.01},{id:"rainCenter",label:"Center",kind:"float",min:0,max:1,step:.01},{id:"rainLimbs",label:"N Limbs",kind:"int",min:1,max:10,step:1},{id:"noiseLP",label:"Mixer Noise LP (Hz)",kind:"int",min:50,max:2e4,step:1}];function j(){try{const t=localStorage.getItem(ce);return t?JSON.parse(t):null}catch{return null}}function R(t){try{localStorage.setItem(ce,JSON.stringify(t))}catch{}}function J(){const t={};for(const e of V){const a={enabled:!1,depEnabled:!1,depTarget:"",depBias:0};e.kind==="bool"||e.kind==="select"?t[e.id]={...a}:t[e.id]={...a,min:e.min,max:e.max,step:e.step}}return t.rmix.enabled=!0,t.rmix.min=.7,t.rmix.max=1,t.rmix.step=.001,t.nbranches.enabled=!0,t.nbranches.min=5,t.nbranches.max=L,t.nbranches.step=1,t.octaves.enabled=!0,t.octaves.min=-2,t.octaves.max=2,t.octaves.step=1,t.decayScale.enabled=!0,t.decayScale.min=.3,t.decayScale.max=4,t.decayScale.step=.01,t.groupEnabled.enabled=!1,t.groupSplit.enabled=!1,t.groupSplit.min=0,t.groupSplit.max=L,t.groupSplit.step=1,t.scaleRoot.enabled=!1,t.scaleName.enabled=!1,t}function X(t){const e=t?JSON.parse(JSON.stringify(t)):{};for(const a of V){const l={enabled:!1,depEnabled:!1,depTarget:"",depBias:0};let o=e[a.id];if(o||(o=a.kind==="bool"||a.kind==="select"?{...l}:{...l,min:a.min,max:a.max,step:a.step}),a.kind!=="bool"&&a.kind!=="select"){let r=parseFloat(o.min),i=parseFloat(o.max);isNaN(r)&&(r=a.min),isNaN(i)&&(i=a.max),r=Math.max(a.min,Math.min(a.max,r)),i=Math.max(a.min,Math.min(a.max,i)),i>r||(r=a.min,i=a.max),o.min=r,o.max=i,o.step=a.step}e[a.id]={...l,...o}}return e}function be(){const t=document.getElementById("randomizerPanel");if(!t)return;const e=X(j()||J()),a=o=>{const r=document.createElement("div");r.className="rand-card";const i=document.createElement("h3");return i.textContent=o,r.appendChild(i),r},l=[{title:"Main",ids:["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupEnabled","groupSplit","scaleRoot","scaleName"]},{title:"Exciter",ids:["noiseLevel","noiseType","lfoEnabled","lfoRate","lfoDepth","lfoWave","exciterCutoff","exciterHP","exciterBandQ","monitorExciter","rainEnabled","rainGain","rainRate","rainDurMs","rainSpread","rainCenter","rainLimbs"]},{title:"Mixer",ids:["noiseLP"]}];t.innerHTML="";for(const o of l){const r=a(o.title);for(const i of o.ids){const s=V.find(c=>c.id===i);if(!s)continue;const u=document.createElement("div");u.className="rand-row";const p=document.createElement("input");p.type="checkbox",p.checked=!!(e[i]&&e[i].enabled),p.addEventListener("change",()=>{e[i]=e[i]||{},e[i].enabled=!!p.checked,R(e)}),u.appendChild(p);const b=document.createElement("div");if(s.kind==="bool"||s.kind==="select"){const c=document.createElement("label");c.textContent=s.label+(s.kind==="select"?" (random pick)":""),b.appendChild(c)}else{const c=document.createElement("label");c.textContent=s.label,b.appendChild(c);const d=document.createElement("div");d.className="range";const E=document.createElement("input");E.type="number",E.step=String(s.step||1),E.value=String((e[i]&&e[i].min)!=null?e[i].min:s.min);const v=document.createElement("input");v.type="number",v.step=String(s.step||1),v.value=String((e[i]&&e[i].max)!=null?e[i].max:s.max);const N=()=>{const w=parseFloat(E.value),D=parseFloat(v.value);e[i]||(e[i]={enabled:!1}),e[i].min=isNaN(w)?s.min:w,e[i].max=isNaN(D)?s.max:D,e[i].step=s.step,R(e)};E.addEventListener("input",N),v.addEventListener("input",N),d.appendChild(E),d.appendChild(v),b.appendChild(d)}const h=document.createElement("div");h.className="dep";const f=document.createElement("input");f.type="checkbox",f.checked=!!(e[i]&&e[i].depEnabled),f.title="Enable dependency";const B=document.createElement("span");B.textContent="Dependency";const x=document.createElement("select"),S=document.createElement("option");S.value="",S.textContent="(choose target)",x.appendChild(S);for(const c of V){if(c.id===i)continue;const d=document.createElement("option");d.value=c.id,d.textContent=c.label,x.appendChild(d)}x.value=e[i]&&e[i].depTarget||"";const C=document.createElement("div");C.className="bias";const T=document.createElement("span");T.textContent="Bias";const y=document.createElement("input");y.type="range",y.min="-1",y.max="1",y.step="0.01",y.value=String(e[i]&&typeof e[i].depBias=="number"?e[i].depBias:0);const k=document.createElement("span"),g=()=>{k.textContent=String(Math.round(parseFloat(y.value)*100))+"%"};g(),y.addEventListener("input",()=>{g(),e[i]||(e[i]={enabled:!1}),e[i].depBias=parseFloat(y.value),R(e)}),f.addEventListener("change",()=>{e[i]=e[i]||{},e[i].depEnabled=!!f.checked,R(e)}),x.addEventListener("change",()=>{e[i]=e[i]||{},e[i].depTarget=x.value,R(e)}),h.appendChild(f),h.appendChild(B),h.appendChild(x),C.appendChild(T),C.appendChild(y),C.appendChild(k),h.appendChild(C),b.appendChild(h),u.appendChild(b),r.appendChild(u)}t.appendChild(r)}}function he(t,e){if(!e||!e.enabled)return null;if(t.kind==="bool")return Math.random()<.5;if(t.kind==="select"){const r=t.options||[];return r.length?r[Math.floor(Math.random()*r.length)]:null}const a=parseFloat(e.min),l=parseFloat(e.max);if(!(l>a))return null;let o=M(a,l);if(t.kind==="int"&&(o=Math.round(o)),t.step){const r=t.step;o=Math.round(o/r)*r}return o}function Ee(){const t=X(j()||J()),e=[...V];e.sort((r,i)=>r.id==="nbranches"?-1:i.id==="nbranches"?1:0);const a={};for(const r of e){const i=he(r,t[r.id]);i!=null&&(a[r.id]=i)}if(a.groupSplit!=null){const r=a.nbranches!=null?a.nbranches:document.getElementById("nbranches")?parseInt(document.getElementById("nbranches").value,10):null;r!=null&&(a.groupSplit=Math.max(0,Math.min(r,a.groupSplit|0)))}const l=Object.fromEntries(V.map(r=>[r.id,r]));for(const r of Object.keys(t)){const i=t[r];if(!i||!i.depEnabled)continue;const s=i.depTarget;if(!s||s===r||a[r]==null||a[s]==null)continue;const u=l[r],p=l[s];if(!u||!p)continue;const b=t[r],h=t[s],f=u.kind==="bool"||u.kind==="select"?0:b&&b.min!=null?b.min:u.min,B=u.kind==="bool"||u.kind==="select"?1:b&&b.max!=null?b.max:u.max,x=p.kind==="bool"||p.kind==="select"?0:h&&h.min!=null?h.min:p.min,S=p.kind==="bool"||p.kind==="select"?1:h&&h.max!=null?h.max:p.max,C=Z(a[r],f,B),T=typeof i.depBias=="number"?Math.max(-1,Math.min(1,i.depBias)):0,y=Math.abs(T),k=Z(a[s],x,S),g=T<0?0:1,c=y*C,d=k+(g-k)*c;a[s]=p.kind==="bool"?d>=.5:p.kind==="int"?Math.round(K(d,x,S)):K(d,x,S)}const o=Object.entries(a);for(const[r,i]of o)r!=="noiseLP"&&G(r,i);if(a.noiseLP!=null){if(window._mixerApi&&typeof window._mixerApi.setNoiseLP=="function")try{window._mixerApi.setNoiseLP(a.noiseLP)}catch{}try{typeof BroadcastChannel<"u"&&new BroadcastChannel("mixer").postMessage({type:"setNoiseLP",value:a.noiseLP})}catch{}}try{if(A){const r={};for(const i of W)a[i]!=null&&(r[i]=a[i]);Object.keys(r).length&&A.postMessage({type:"setMultiple",values:r,source:"main"})}}catch{}document.getElementById("rmix")&&F()}function xe(t){const e=document.createElement("div");e.className="grid row",e.dataset.index=String(t);const a=document.createElement("span");a.textContent=String(t+1),e.appendChild(a);const l=document.createElement("input");l.type="range",l.min="0",l.max="1",l.step="0.001",l.value=String(_(440)),l.dataset.role="freq",e.appendChild(l);const o=document.createElement("input");o.type="range",o.min="50",o.max="3000",o.step="1",o.value="400",o.dataset.role="decay",e.appendChild(o);const r=document.createElement("input");r.type="range",r.min="0",r.max="1",r.step="0.001",r.value="0.2",r.dataset.role="amp",e.appendChild(r);const i=document.createElement("input");i.type="range",i.min="-1",i.max="1",i.step="0.001",i.value="0",i.dataset.role="pan",e.appendChild(i);const s=()=>{if(!n)return;const u={freq:oe(parseFloat(l.value)),decay:parseFloat(o.value),amp:parseFloat(r.value),pan:parseFloat(i.value)};n.setBranchParams(t,u)};return l.addEventListener("input",s),o.addEventListener("input",s),r.addEventListener("input",s),i.addEventListener("input",s),e}function H(t){document.querySelectorAll("#branches .row").forEach((a,l)=>{a.style.display=l<t?"grid":"none"})}function ye(t){const e=[],a=document.querySelectorAll("#branches .row");for(let l=0;l<t;l+=1){const o=Math.round(M(100,2e3)),r=Math.round(M(100,800)),i=le(M(.005,.05)),s=M(-1,1);e.push({freq:o,decay:r,amp:i,pan:s});const u=a[l];u.querySelector('input[data-role="freq"]').value=String(_(o)),u.querySelector('input[data-role="decay"]').value=String(r),u.querySelector('input[data-role="amp"]').value=String(i),u.querySelector('input[data-role="pan"]').value=String(s)}n&&n.setAllBranches(e)}function ve(t,e){const a=document.querySelectorAll("#branches .row"),l=Math.max(0,t|0),o=Math.min(L,e|0);for(let r=l;r<o;r+=1){const i=Math.round(M(100,2e3)),s=Math.round(M(100,800)),u=le(M(.005,.05)),p=M(-1,1),b=a[r];if(!b)continue;const h=b.querySelector('input[data-role="freq"]'),f=b.querySelector('input[data-role="decay"]'),B=b.querySelector('input[data-role="amp"]'),x=b.querySelector('input[data-role="pan"]');h&&(h.value=String(_(i))),f&&(f.value=String(s)),B&&(B.value=String(u)),x&&(x.value=String(p)),n&&n.setBranchParams(r,{freq:i,decay:s,amp:u,pan:p})}}function de(){const t=parseInt(document.getElementById("nbranches").value,10)||4,e=document.querySelectorAll("#branches .row"),a=[];for(let l=0;l<t;l+=1){const o=e[l],r=parseFloat(o.querySelector('input[data-role="freq"]').value),i=parseFloat(o.querySelector('input[data-role="decay"]').value),s=parseFloat(o.querySelector('input[data-role="pan"]').value),u=o.querySelector('input[data-role="amp"]');u&&(u.value="0.2"),a.push({freq:oe(r),decay:i,amp:.2,pan:s})}n&&n.setAllBranches(a),F()}function F(){const t=e=>document.getElementById(e);t("noiseLevel")&&(t("noiseLevelVal").textContent=Number(t("noiseLevel").value).toFixed(2)),t("rmixVal").textContent=Number(t("rmix").value).toFixed(2),t("nbranchesVal").textContent=t("nbranches").value,t("freqScaleVal").textContent=Number(t("freqScale").value).toFixed(2),t("octaves")&&(t("octavesVal").textContent=String(parseInt(t("octaves").value,10))),t("burstRate")&&(t("burstRateVal").textContent=Number(t("burstRate").value).toFixed(2)),t("burstDurMs")&&(t("burstDurMsVal").textContent=t("burstDurMs").value),t("impulseGain")&&(t("impulseGainVal").textContent=Number(t("impulseGain").value).toFixed(2)),t("exciterHP")&&(t("exciterHPVal").textContent=t("exciterHP").value),t("freqCenterVal").textContent=t("freqCenter").value,t("decayScaleVal").textContent=Number(t("decayScale").value).toFixed(2),t("groupSplit")&&(t("groupSplitVal").textContent=String(parseInt(t("groupSplit").value,10))),t("exciterBandQ")&&(t("exciterBandQVal").textContent=t("exciterBandQ").value),t("rainRate")&&(t("rainRateVal").textContent=Number(t("rainRate").value).toFixed(2)),t("rainDurMs")&&(t("rainDurMsVal").textContent=t("rainDurMs").value),t("rainGain")&&(t("rainGainVal").textContent=Number(t("rainGain").value).toFixed(2)),t("rainSpread")&&(t("rainSpreadVal").textContent=Number(t("rainSpread").value).toFixed(2)),t("rainCenter")&&(t("rainCenterVal").textContent=Number(t("rainCenter").value).toFixed(2)),t("rainLimbs")&&(t("rainLimbsVal").textContent=t("rainLimbs").value)}async function Be(){if(m)return;m=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100,latencyHint:"playback"}),n=await O.create(m);const t=m.createGain();t.gain.value=1;const e=m.createGain();e.gain.value=1;const a=m.createBiquadFilter();a.type="lowpass",a.frequency.value=2e4,n.connect(a,0,0),a.connect(t),n.connect(e,1,0),t.connect(m.destination),e.connect(m.destination);const l=m.createAnalyser();l.fftSize=1024;const o=m.createAnalyser();o.fftSize=1024,t.connect(l),e.connect(o);const r=new Float32Array(l.fftSize),i=new Float32Array(o.fftSize),s=()=>{const g=document.getElementById("meter0Bar"),c=document.getElementById("meter1Bar");if(g&&c){l.getFloatTimeDomainData(r),o.getFloatTimeDomainData(i);let d=0;for(let I=0;I<r.length;I+=1)d+=r[I]*r[I];let E=0;for(let I=0;I<i.length;I+=1)E+=i[I]*i[I];const v=Math.sqrt(d/r.length),N=Math.sqrt(E/i.length),w=20*Math.log10(Math.max(1e-6,v)),D=20*Math.log10(Math.max(1e-6,N)),ue=Math.max(0,Math.min(1,(w+60)/60)),me=Math.max(0,Math.min(1,(D+60)/60));g.style.height=String(Math.round(ue*100))+"%",c.style.height=String(Math.round(me*100))+"%"}requestAnimationFrame(s)};requestAnimationFrame(s),window._mixerApi={setNoiseLP(g){a.frequency.setTargetAtTime(Math.max(50,Math.min(2e4,g||2e4)),m.currentTime,.02)},getNoiseLP:()=>a.frequency.value,getContext:()=>m,getNode:()=>n},console.info("AudioContext started",{sampleRate:m.sampleRate,baseLatency:m.baseLatency});const u=g=>document.getElementById(g),p=["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupSplit"],b=["noiseType","lfoRate","lfoDepth","exciterCutoff","exciterHP","exciterBandQ","rainRate","rainDurMs","rainGain","rainSpread","rainCenter","rainLimbs"];for(const g of b)document.getElementById(g)&&p.push(g);if(p.forEach(g=>{const c=u(g);c&&c.addEventListener("input",()=>{if(F(),!n)return;const d=m.currentTime;switch(g){case"noiseLevel":n.noiseLevel.setValueAtTime(parseFloat(c.value),d);break;case"noiseType":n.noiseType.setValueAtTime(parseInt(c.value,10),d);break;case"rmix":n.rmix.setValueAtTime(parseFloat(c.value),d);break;case"nbranches":{const E=parseInt(c.value,10);n.nbranches.setValueAtTime(E,d),H(E);const v=document.getElementById("groupSplit");v&&(v.max=String(E),parseInt(v.value,10)>E&&(v.value=String(E))),E>q&&ve(q,E),q=E;break}case"freqScale":n.freqScale.setValueAtTime(parseFloat(c.value),d);break;case"octaves":n.octaves.setValueAtTime(parseInt(c.value,10),d);break;case"exciterCutoff":n.exciterCutoff.setValueAtTime(parseFloat(c.value),d);break;case"exciterHP":n.exciterHP.setValueAtTime(parseFloat(c.value),d);break;case"burstRate":n.burstRate.setValueAtTime(parseFloat(c.value),d);break;case"burstDurMs":n.burstDurMs.setValueAtTime(parseFloat(c.value),d);break;case"impulseGain":n.impulseGain.setValueAtTime(parseFloat(c.value),d);break;case"freqCenter":n.freqCenter.setValueAtTime(parseFloat(c.value),d);break;case"decayScale":n.decayScale.setValueAtTime(parseFloat(c.value),d);break;case"exciterBandQ":n.exciterBandQ.setValueAtTime(parseFloat(c.value),d);break;case"groupSplit":n.groupSplit.setValueAtTime(parseInt(c.value,10),d);break}})}),typeof BroadcastChannel<"u"){const g=new BroadcastChannel("mixer");g.onmessage=c=>{const d=c.data||{};if(d.type==="setNoiseLP"&&typeof d.value=="number")try{a.frequency.setTargetAtTime(Math.max(50,Math.min(2e4,d.value)),m.currentTime,.02)}catch{}}}const h=document.getElementById("groupEnabled");h&&h.addEventListener("change",()=>{n&&n.groupEnabled.setValueAtTime(h.checked?1:0,m.currentTime)});const f=document.getElementById("rainEnabled");f&&f.addEventListener("change",()=>{n&&n.rainEnabled.setValueAtTime(f.checked?1:0,m.currentTime)});const B=document.getElementById("lfoEnabled");B&&B.addEventListener("change",()=>{n&&n.lfoEnabled.setValueAtTime(B.checked?1:0,m.currentTime)});const x=document.getElementById("lfoWave");x&&x.addEventListener("change",()=>{n&&n.lfoWave.setValueAtTime(parseInt(x.value,10),m.currentTime)});const S=document.getElementById("monitorExciter");S&&S.addEventListener("change",()=>{n&&n.monitorExciter.setValueAtTime(S.checked?1:0,m.currentTime)});const C=document.getElementById("scaleRoot"),T=document.getElementById("scaleName"),y=()=>{if(!n)return;const g=T.value,c=C.value;n.setScale({name:g,root:c}),n.quantize.setValueAtTime(g==="off"?0:1,m.currentTime)};C.addEventListener("change",y),T.addEventListener("change",y);const k=parseInt(document.getElementById("nbranches").value,10)||16;n.nbranches.setValueAtTime(k,m.currentTime),H(k),q=k,(function(){C&&T&&y()})(),de(),P()}const Y=document.getElementById("branches");if(Y)for(let t=0;t<L;t+=1)Y.appendChild(xe(t));const $=document.getElementById("startBtn");$&&$.addEventListener("click",Be);const U=document.getElementById("randomizeBtn");U&&U.addEventListener("click",()=>{const t=parseInt(document.getElementById("nbranches").value,10)||16;Ee();const e=parseInt(document.getElementById("nbranches").value,10)||t;ye(e);const a=document.getElementById("scaleRoot"),l=document.getElementById("scaleName"),o=X(j()||J());if(!(o.scaleRoot&&o.scaleRoot.enabled||o.scaleName&&o.scaleName.enabled)&&a&&l){const i=Array.from(a.options).map(f=>f.value),s=Array.from(l.options).map(f=>f.value),u=s.filter(f=>f!=="off"),p=f=>f[Math.floor(Math.random()*f.length)],b=p(i),h=p(u.length?u:s);a.value=b,l.value=h,a.dispatchEvent(new Event("change",{bubbles:!0})),l.dispatchEvent(new Event("change",{bubbles:!0}))}});const ee=document.getElementById("resetBtn");ee&&ee.addEventListener("click",()=>{document.getElementById("noiseLevel")&&(document.getElementById("noiseLevel").value="0.03"),document.getElementById("rmix").value="1",document.getElementById("nbranches").value="4",document.getElementById("freqScale").value="1",document.getElementById("octaves").value="0",document.getElementById("exciterCutoff")&&(document.getElementById("exciterCutoff").value="4000"),document.getElementById("exciterHP")&&(document.getElementById("exciterHP").value="50"),document.getElementById("noiseType")&&(document.getElementById("noiseType").value="0"),document.getElementById("lfoEnabled")&&(document.getElementById("lfoEnabled").checked=!0),document.getElementById("lfoRate")&&(document.getElementById("lfoRate").value="0.10"),document.getElementById("lfoDepth")&&(document.getElementById("lfoDepth").value="0.56"),document.getElementById("lfoWave")&&(document.getElementById("lfoWave").value="0"),document.getElementById("rainEnabled")&&(document.getElementById("rainEnabled").checked=!0),document.getElementById("rainRate")&&(document.getElementById("rainRate").value="0.81"),document.getElementById("rainDurMs")&&(document.getElementById("rainDurMs").value="8"),document.getElementById("rainGain")&&(document.getElementById("rainGain").value="0.85"),document.getElementById("rainSpread")&&(document.getElementById("rainSpread").value="0.69"),document.getElementById("rainCenter")&&(document.getElementById("rainCenter").value="0.55"),document.getElementById("rainLimbs")&&(document.getElementById("rainLimbs").value="9"),document.getElementById("monitorExciter")&&(document.getElementById("monitorExciter").checked=!1),document.getElementById("freqCenter").value="0",document.getElementById("decayScale").value="1",document.getElementById("groupEnabled")&&(document.getElementById("groupEnabled").checked=!1),document.getElementById("groupSplit")&&(document.getElementById("groupSplit").value="0");const t=document.getElementById("exciterBandQ");if(t&&(t.value="30"),document.getElementById("scaleRoot")&&(document.getElementById("scaleRoot").value="A"),document.getElementById("scaleName")&&(document.getElementById("scaleName").value="off"),F(),n&&m){const e=m.currentTime;n.noiseLevel.setValueAtTime(.03,e),n.noiseType&&n.noiseType.setValueAtTime(1,e),n.lfoEnabled&&n.lfoEnabled.setValueAtTime(1,e),n.lfoRate&&n.lfoRate.setValueAtTime(.1,e),n.lfoDepth&&n.lfoDepth.setValueAtTime(.56,e),n.lfoWave&&n.lfoWave.setValueAtTime(0,e),n.rmix.setValueAtTime(1,e),n.nbranches.setValueAtTime(4,e),n.freqScale.setValueAtTime(1,e),n.octaves.setValueAtTime(0,e),n.exciterCutoff&&n.exciterCutoff.setValueAtTime(4e3,e),n.exciterHP&&n.exciterHP.setValueAtTime(50,e),n.rainEnabled&&n.rainEnabled.setValueAtTime(1,e),n.rainRate&&n.rainRate.setValueAtTime(.83,e),n.rainDurMs&&n.rainDurMs.setValueAtTime(61,e),n.rainGain&&n.rainGain.setValueAtTime(.62,e),n.rainSpread&&n.rainSpread.setValueAtTime(.71,e),n.rainCenter&&n.rainCenter.setValueAtTime(.49,e),n.rainLimbs&&n.rainLimbs.setValueAtTime(10,e),n.monitorExciter&&n.monitorExciter.setValueAtTime(0,e),n.freqCenter.setValueAtTime(0,e),n.decayScale.setValueAtTime(1,e),n.groupEnabled&&n.groupEnabled.setValueAtTime(0,e),n.groupSplit&&n.groupSplit.setValueAtTime(0,e),n.quantize.setValueAtTime(0,e),n.setScale&&n.setScale({name:"off",root:"A"}),H(4),q=4}de(),P()});document.getElementById("rmix")&&F();ge();const te=document.getElementById("openControlsBtn");te&&te.addEventListener("click",()=>{window.open("control.html","Exciter Controls")});const ne=document.getElementById("openMixerBtn");ne&&ne.addEventListener("click",()=>{window.open("mixer.html","Mixer")});const ae=document.getElementById("openRandomizerBtn");ae&&ae.addEventListener("click",()=>{window.open("randomizer.html","Randomizer")});document.getElementById("randomizerPanel")&&be();
