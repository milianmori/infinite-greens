(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&l(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();class X extends AudioWorkletNode{static async create(e){try{await e.audioWorklet.addModule("resonator-processor.js")}catch{}return new X(e)}constructor(e){super(e,"resonator-processor",{numberOfInputs:0,numberOfOutputs:3,outputChannelCount:[2,2,5],parameterData:{nbranches:4,noiseLevel:.03,noiseType:1,lfoEnabled:1,lfoRate:.1,lfoDepth:.7,lfoWave:0,rmix:1,quantize:0,exciterCutoff:4e3,exciterHP:50,rainEnabled:1,rainGain:.62,rainRate:.83,rainDurMs:61,rainSpread:.71,rainCenter:.49,rainLimbs:10,monitorExciter:0,groupEnabled:0,groupSplit:0,octaves:0,freqScale:1,freqCenter:0,decayScale:1,exciterBandQNoise:30,exciterBandQRain:30}})}get nbranches(){return this.parameters.get("nbranches")}get noiseLevel(){return this.parameters.get("noiseLevel")}get noiseType(){return this.parameters.get("noiseType")}get lfoEnabled(){return this.parameters.get("lfoEnabled")}get lfoRate(){return this.parameters.get("lfoRate")}get lfoDepth(){return this.parameters.get("lfoDepth")}get lfoWave(){return this.parameters.get("lfoWave")}get rmix(){return this.parameters.get("rmix")}get quantize(){return this.parameters.get("quantize")}get exciterCutoff(){return this.parameters.get("exciterCutoff")}get exciterHP(){return this.parameters.get("exciterHP")}get groupEnabled(){return this.parameters.get("groupEnabled")}get groupSplit(){return this.parameters.get("groupSplit")}get octaves(){return this.parameters.get("octaves")}get rainEnabled(){return this.parameters.get("rainEnabled")}get rainGain(){return this.parameters.get("rainGain")}get rainRate(){return this.parameters.get("rainRate")}get rainDurMs(){return this.parameters.get("rainDurMs")}get rainSpread(){return this.parameters.get("rainSpread")}get rainCenter(){return this.parameters.get("rainCenter")}get rainLimbs(){return this.parameters.get("rainLimbs")}get monitorExciter(){return this.parameters.get("monitorExciter")}get freqScale(){return this.parameters.get("freqScale")}get freqCenter(){return this.parameters.get("freqCenter")}get decayScale(){return this.parameters.get("decayScale")}get exciterBandQNoise(){return this.parameters.get("exciterBandQNoise")}get exciterBandQRain(){return this.parameters.get("exciterBandQRain")}setBranchParams(e,{freq:n,decay:l,amp:o,pan:i}){this.port.postMessage({type:"setBranchParams",index:e,params:{freq:n,decay:l,amp:o,pan:i}})}setAllBranches(e){this.port.postMessage({type:"setAllBranches",branches:e})}setScale({name:e,root:n}){this.port.postMessage({type:"setScale",name:e,root:n})}}let m=null,a=null;const D=40;let z=0;const Y=["noiseLevel","noiseType","lfoEnabled","lfoRate","lfoDepth","lfoWave","exciterCutoff","exciterHP","exciterBandQNoise","exciterBandQRain","monitorExciter","rainEnabled","rainGain","rainRate","rainDurMs","rainSpread","rainCenter","rainLimbs"];let K=!1,N=null;function W(t){return document.getElementById(t)}const O="uiStateV1",Q="exciterStateV1";function j(t){try{const e=localStorage.getItem(t);return e?JSON.parse(e):null}catch{return null}}function me(t,e){try{localStorage.setItem(t,JSON.stringify(e||{}))}catch{}}function Ie(t,e,n){if(t)if(t.type==="checkbox")t.checked=!!n,t.dispatchEvent(new Event("change",{bubbles:!0}));else{t.value=String(n);const l=t.tagName==="SELECT"?"change":"input";t.dispatchEvent(new Event(l,{bubbles:!0}))}}const Me=["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupEnabled","groupSplit","scaleRoot","scaleName"];function J(t){const n={...j(O)||{},...t};me(O,n)}function Ae(){const t=j(O);if(t)for(const e of Me){if(!(e in t))continue;const n=W(e);n&&Ie(n,e,t[e])}}function pe(t){const n={...j(Q)||{},...t};me(Q,n)}function fe(){return j(Q)||null}function Re(t,e){if(!a||!m)return;const n=m.currentTime;switch(t){case"noiseLevel":a.noiseLevel&&a.noiseLevel.setValueAtTime(parseFloat(e),n);break;case"noiseType":a.noiseType&&a.noiseType.setValueAtTime(parseInt(e,10),n);break;case"lfoEnabled":a.lfoEnabled&&a.lfoEnabled.setValueAtTime(e?1:0,n);break;case"lfoRate":a.lfoRate&&a.lfoRate.setValueAtTime(parseFloat(e),n);break;case"lfoDepth":a.lfoDepth&&a.lfoDepth.setValueAtTime(parseFloat(e),n);break;case"lfoWave":a.lfoWave&&a.lfoWave.setValueAtTime(parseInt(e,10),n);break;case"exciterCutoff":a.exciterCutoff&&a.exciterCutoff.setValueAtTime(parseFloat(e),n);break;case"exciterHP":a.exciterHP&&a.exciterHP.setValueAtTime(parseFloat(e),n);break;case"exciterBandQNoise":a.exciterBandQNoise&&a.exciterBandQNoise.setValueAtTime(parseFloat(e),n);break;case"exciterBandQRain":a.exciterBandQRain&&a.exciterBandQRain.setValueAtTime(parseFloat(e),n);break;case"monitorExciter":a.monitorExciter&&a.monitorExciter.setValueAtTime(e?1:0,n);break;case"rainEnabled":a.rainEnabled&&a.rainEnabled.setValueAtTime(e?1:0,n);break;case"rainGain":a.rainGain&&a.rainGain.setValueAtTime(parseFloat(e),n);break;case"rainRate":a.rainRate&&a.rainRate.setValueAtTime(parseFloat(e),n);break;case"rainDurMs":a.rainDurMs&&a.rainDurMs.setValueAtTime(parseFloat(e),n);break;case"rainSpread":a.rainSpread&&a.rainSpread.setValueAtTime(parseFloat(e),n);break;case"rainCenter":a.rainCenter&&a.rainCenter.setValueAtTime(parseFloat(e),n);break;case"rainLimbs":a.rainLimbs&&a.rainLimbs.setValueAtTime(parseInt(e,10),n);break}}function Ve(){const t={};for(const e of Y){const n=W(e);if(!n){e==="noiseLevel"&&a&&a.noiseLevel&&(t[e]=a.noiseLevel.value);continue}n.type==="checkbox"?t[e]=!!n.checked:t[e]=n.value}return t}function _(t){if(!N)return;let e=t||Ve();const n=fe();n&&(e={...n,...e}),N.postMessage({type:"state",source:"main",state:e,partial:!!t})}function H(t,e){const n=W(t);if(!n){Re(t,e);return}K=!0;try{if(n.type==="checkbox")n.checked=!!e,n.dispatchEvent(new Event("change",{bubbles:!0}));else{n.value=String(e);const l=n.tagName==="SELECT"?"change":"input";n.dispatchEvent(new Event(l,{bubbles:!0}))}}finally{K=!1}pe({[t]:e})}function Le(){if(!N&&!(typeof BroadcastChannel>"u")){N=new BroadcastChannel("exciter-controls"),N.onmessage=t=>{const e=t.data||{};if(e.source!=="main")if(e.type==="set"&&e.id)H(e.id,e.value);else if(e.type==="setMultiple"&&e.values){const n=Object.entries(e.values);for(const[l,o]of n)H(l,o)}else e.type==="requestState"&&_()};for(const t of Y){const e=W(t);if(!e)continue;const n=()=>{if(K)return;const l=e.type==="checkbox"?!!e.checked:e.value;pe({[t]:l}),_({[t]:l})};e.addEventListener("input",n),e.addEventListener("change",n)}}}const ge=25,be=8e3;function Z(t){const e=ge,n=be,l=Math.min(Math.max(t,e),n);return Math.log(l/e)/Math.log(n/e)}function he(t){const e=ge,n=be,l=Math.min(Math.max(t,0),1);return e*Math.pow(n/e,l)}function V(t,e){return Math.random()*(e-t)+t}function Ee(t){return Math.round(t*100)/100}function xe(t){return Math.max(0,Math.min(1,t))}function ne(t,e,n){return n>e?xe((t-e)/(n-e)):0}function ae(t,e,n){const l=xe(t);return e+l*(n-e)}const ye="randomizerConfigV1",w=[{id:"rmix",label:"Mix (rmix)",kind:"float",min:0,max:1,step:.001},{id:"nbranches",label:"Branch count",kind:"int",min:1,max:D,step:1},{id:"freqScale",label:"Freq Scale",kind:"float",min:.25,max:4,step:.01},{id:"octaves",label:"Octave Transpose",kind:"int",min:-4,max:2,step:1},{id:"freqCenter",label:"Freq Center (Hz)",kind:"int",min:-2e3,max:2e3,step:1},{id:"decayScale",label:"Decay Scale",kind:"float",min:.25,max:4,step:.01},{id:"groupEnabled",label:"Group Mode",kind:"bool"},{id:"groupSplit",label:"Group Split",kind:"int",min:0,max:D,step:1},{id:"scaleRoot",label:"Scale Root",kind:"select",options:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]},{id:"scaleName",label:"Scale",kind:"select",options:["off","chromatic","major","minor","harmonicMinor","melodicMinor","dorian","phrygian","lydian","mixolydian","locrian","pentatonicMajor","pentatonicMinor","blues","wholeTone","octatonic12","octatonic21"]},{id:"noiseLevel",label:"Noise Level",kind:"float",min:0,max:.5,step:.001},{id:"noiseType",label:"Noise Type",kind:"int",min:0,max:3,step:1},{id:"lfoEnabled",label:"LFO Enable",kind:"bool"},{id:"lfoRate",label:"LFO Rate (Hz)",kind:"float",min:.1,max:20,step:.01},{id:"lfoDepth",label:"LFO Depth",kind:"float",min:0,max:1,step:.01},{id:"lfoWave",label:"LFO Wave",kind:"int",min:0,max:3,step:1},{id:"exciterCutoff",label:"Exciter LP (Hz)",kind:"int",min:50,max:2e4,step:1},{id:"exciterHP",label:"Exciter HP (Hz)",kind:"int",min:10,max:2e3,step:1},{id:"exciterBandQNoise",label:"Exciter Band Q (Noise)",kind:"float",min:.5,max:80,step:.5},{id:"exciterBandQRain",label:"Exciter Band Q (Rain)",kind:"float",min:.5,max:80,step:.5},{id:"monitorExciter",label:"Monitor Exciter Only",kind:"bool"},{id:"rainEnabled",label:"Rain Enabled",kind:"bool"},{id:"rainGain",label:"Rain Gain",kind:"float",min:0,max:1,step:.01},{id:"rainRate",label:"Rain Rate (Hz)",kind:"float",min:.1,max:40,step:.01},{id:"rainDurMs",label:"Drop Duration (ms)",kind:"int",min:1,max:200,step:1},{id:"rainSpread",label:"Spread",kind:"float",min:0,max:1,step:.01},{id:"rainCenter",label:"Center",kind:"float",min:0,max:1,step:.01},{id:"rainLimbs",label:"N Limbs",kind:"int",min:1,max:10,step:1}];function $(){try{const t=localStorage.getItem(ye);return t?JSON.parse(t):null}catch{return null}}function G(t){try{localStorage.setItem(ye,JSON.stringify(t))}catch{}}function ee(){const t={};for(const e of w){const n={enabled:!1,depEnabled:!1,depTarget:"",depBias:0};e.kind==="bool"||e.kind==="select"?t[e.id]={...n}:t[e.id]={...n,min:e.min,max:e.max,step:e.step}}return t.rmix.enabled=!0,t.rmix.min=.7,t.rmix.max=1,t.rmix.step=.001,t.nbranches.enabled=!0,t.nbranches.min=5,t.nbranches.max=D,t.nbranches.step=1,t.octaves.enabled=!0,t.octaves.min=-2,t.octaves.max=2,t.octaves.step=1,t.decayScale.enabled=!0,t.decayScale.min=.3,t.decayScale.max=4,t.decayScale.step=.01,t.groupEnabled.enabled=!1,t.groupSplit.enabled=!1,t.groupSplit.min=0,t.groupSplit.max=D,t.groupSplit.step=1,t.scaleRoot.enabled=!1,t.scaleName.enabled=!1,t}function te(t){const e=t?JSON.parse(JSON.stringify(t)):{};for(const n of w){const l={enabled:!1,depEnabled:!1,depTarget:"",depBias:0};let o=e[n.id];if(o||(o=n.kind==="bool"||n.kind==="select"?{...l}:{...l,min:n.min,max:n.max,step:n.step}),n.kind!=="bool"&&n.kind!=="select"){let i=parseFloat(o.min),r=parseFloat(o.max);isNaN(i)&&(i=n.min),isNaN(r)&&(r=n.max),i=Math.max(n.min,Math.min(n.max,i)),r=Math.max(n.min,Math.min(n.max,r)),r>i||(i=n.min,r=n.max),o.min=i,o.max=r,o.step=n.step}e[n.id]={...l,...o}}return e}function Ne(){const t=document.getElementById("randomizerPanel");if(!t)return;const e=te($()||ee()),n=o=>{const i=document.createElement("div");i.className="rand-card";const r=document.createElement("h3");return r.textContent=o,i.appendChild(r),i},l=[{title:"Main",ids:["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupEnabled","groupSplit","scaleRoot","scaleName"]},{title:"Exciter",ids:["noiseLevel","noiseType","lfoEnabled","lfoRate","lfoDepth","lfoWave","exciterCutoff","exciterHP","exciterBandQNoise","exciterBandQRain","monitorExciter","rainEnabled","rainGain","rainRate","rainDurMs","rainSpread","rainCenter","rainLimbs"]}];t.innerHTML="";for(const o of l){const i=n(o.title);for(const r of o.ids){const s=w.find(E=>E.id===r);if(!s)continue;const u=document.createElement("div");u.className="rand-row";const p=document.createElement("input");p.type="checkbox",p.checked=!!(e[r]&&e[r].enabled),p.addEventListener("change",()=>{e[r]=e[r]||{},e[r].enabled=!!p.checked,G(e)}),u.appendChild(p);const f=document.createElement("div");if(s.kind==="bool"||s.kind==="select"){const E=document.createElement("label");E.textContent=s.label+(s.kind==="select"?" (random pick)":""),f.appendChild(E)}else{const E=document.createElement("label");E.textContent=s.label,f.appendChild(E);const x=document.createElement("div");x.className="range";const k=document.createElement("input");k.type="number",k.step=String(s.step||1),k.value=String((e[r]&&e[r].min)!=null?e[r].min:s.min);const I=document.createElement("input");I.type="number",I.step=String(s.step||1),I.value=String((e[r]&&e[r].max)!=null?e[r].max:s.max);const F=()=>{const d=parseFloat(k.value),c=parseFloat(I.value);e[r]||(e[r]={enabled:!1}),e[r].min=isNaN(d)?s.min:d,e[r].max=isNaN(c)?s.max:c,e[r].step=s.step,G(e)};k.addEventListener("input",F),I.addEventListener("input",F),x.appendChild(k),x.appendChild(I),f.appendChild(x)}const b=document.createElement("div");b.className="dep";const g=document.createElement("input");g.type="checkbox",g.checked=!!(e[r]&&e[r].depEnabled),g.title="Enable dependency";const S=document.createElement("span");S.textContent="Dependency";const y=document.createElement("select"),T=document.createElement("option");T.value="",T.textContent="(choose target)",y.appendChild(T);for(const E of w){if(E.id===r)continue;const x=document.createElement("option");x.value=E.id,x.textContent=E.label,y.appendChild(x)}y.value=e[r]&&e[r].depTarget||"";const M=document.createElement("div");M.className="bias";const C=document.createElement("span");C.textContent="Bias";const v=document.createElement("input");v.type="range",v.min="-1",v.max="1",v.step="0.01",v.value=String(e[r]&&typeof e[r].depBias=="number"?e[r].depBias:0);const A=document.createElement("span"),L=()=>{A.textContent=String(Math.round(parseFloat(v.value)*100))+"%"};L(),v.addEventListener("input",()=>{L(),e[r]||(e[r]={enabled:!1}),e[r].depBias=parseFloat(v.value),G(e)}),g.addEventListener("change",()=>{e[r]=e[r]||{},e[r].depEnabled=!!g.checked,G(e)}),y.addEventListener("change",()=>{e[r]=e[r]||{},e[r].depTarget=y.value,G(e)}),b.appendChild(g),b.appendChild(S),b.appendChild(y),M.appendChild(C),M.appendChild(v),M.appendChild(A),b.appendChild(M),f.appendChild(b),u.appendChild(f),i.appendChild(u)}t.appendChild(i)}}function Fe(t,e){if(!e||!e.enabled)return null;if(t.kind==="bool")return Math.random()<.5;if(t.kind==="select"){const i=t.options||[];return i.length?i[Math.floor(Math.random()*i.length)]:null}const n=parseFloat(e.min),l=parseFloat(e.max);if(!(l>n))return null;let o=V(n,l);if(t.kind==="int"&&(o=Math.round(o)),t.step){const i=t.step;o=Math.round(o/i)*i}return o}function qe(){const t=te($()||ee()),e=[...w];e.sort((i,r)=>i.id==="nbranches"?-1:r.id==="nbranches"?1:0);const n={};for(const i of e){const r=Fe(i,t[i.id]);r!=null&&(n[i.id]=r)}if(n.groupSplit!=null){const i=n.nbranches!=null?n.nbranches:document.getElementById("nbranches")?parseInt(document.getElementById("nbranches").value,10):null;i!=null&&(n.groupSplit=Math.max(0,Math.min(i,n.groupSplit|0)))}const l=Object.fromEntries(w.map(i=>[i.id,i]));for(const i of Object.keys(t)){const r=t[i];if(!r||!r.depEnabled)continue;const s=r.depTarget;if(!s||s===i||n[i]==null||n[s]==null)continue;const u=l[i],p=l[s];if(!u||!p)continue;const f=t[i],b=t[s],g=u.kind==="bool"||u.kind==="select"?0:f&&f.min!=null?f.min:u.min,S=u.kind==="bool"||u.kind==="select"?1:f&&f.max!=null?f.max:u.max,y=p.kind==="bool"||p.kind==="select"?0:b&&b.min!=null?b.min:p.min,T=p.kind==="bool"||p.kind==="select"?1:b&&b.max!=null?b.max:p.max,M=ne(n[i],g,S),C=typeof r.depBias=="number"?Math.max(-1,Math.min(1,r.depBias)):0,v=Math.abs(C),A=ne(n[s],y,T),L=C<0?0:1,E=v*M,x=A+(L-A)*E;n[s]=p.kind==="bool"?x>=.5:p.kind==="int"?Math.round(ae(x,y,T)):ae(x,y,T)}const o=Object.entries(n);for(const[i,r]of o)H(i,r);try{if(N){const i={};for(const r of Y)n[r]!=null&&(i[r]=n[r]);Object.keys(i).length&&N.postMessage({type:"setMultiple",values:i,source:"main"})}}catch{}document.getElementById("rmix")&&P()}function De(t){const e=document.createElement("div");e.className="grid row",e.dataset.index=String(t);const n=document.createElement("span");n.textContent=String(t+1),e.appendChild(n);const l=document.createElement("input");l.type="range",l.min="0",l.max="1",l.step="0.001",l.value=String(Z(440)),l.dataset.role="freq",e.appendChild(l);const o=document.createElement("input");o.type="range",o.min="50",o.max="3000",o.step="1",o.value="400",o.dataset.role="decay",e.appendChild(o);const i=document.createElement("input");i.type="range",i.min="0",i.max="1",i.step="0.001",i.value="0.2",i.dataset.role="amp",e.appendChild(i);const r=document.createElement("input");r.type="range",r.min="-1",r.max="1",r.step="0.001",r.value="0",r.dataset.role="pan",e.appendChild(r);const s=()=>{if(!a)return;const u={freq:he(parseFloat(l.value)),decay:parseFloat(o.value),amp:parseFloat(i.value),pan:parseFloat(r.value)};a.setBranchParams(t,u)};return l.addEventListener("input",s),o.addEventListener("input",s),i.addEventListener("input",s),r.addEventListener("input",s),e}function U(t){document.querySelectorAll("#branches .row").forEach((n,l)=>{n.style.display=l<t?"grid":"none"})}function we(t){const e=[],n=document.querySelectorAll("#branches .row");for(let l=0;l<t;l+=1){const o=Math.round(V(100,2e3)),i=Math.round(V(100,800)),r=Ee(V(.005,.05)),s=V(-1,1);e.push({freq:o,decay:i,amp:r,pan:s});const u=n[l];u.querySelector('input[data-role="freq"]').value=String(Z(o)),u.querySelector('input[data-role="decay"]').value=String(i),u.querySelector('input[data-role="amp"]').value=String(r),u.querySelector('input[data-role="pan"]').value=String(s)}a&&a.setAllBranches(e)}function Ge(t,e){const n=document.querySelectorAll("#branches .row"),l=Math.max(0,t|0),o=Math.min(D,e|0);for(let i=l;i<o;i+=1){const r=Math.round(V(100,2e3)),s=Math.round(V(100,800)),u=Ee(V(.005,.05)),p=V(-1,1),f=n[i];if(!f)continue;const b=f.querySelector('input[data-role="freq"]'),g=f.querySelector('input[data-role="decay"]'),S=f.querySelector('input[data-role="amp"]'),y=f.querySelector('input[data-role="pan"]');b&&(b.value=String(Z(r))),g&&(g.value=String(s)),S&&(S.value=String(u)),y&&(y.value=String(p)),a&&a.setBranchParams(i,{freq:r,decay:s,amp:u,pan:p})}}function ve(){const t=parseInt(document.getElementById("nbranches").value,10)||4,e=document.querySelectorAll("#branches .row"),n=[];for(let l=0;l<t;l+=1){const o=e[l],i=parseFloat(o.querySelector('input[data-role="freq"]').value),r=parseFloat(o.querySelector('input[data-role="decay"]').value),s=parseFloat(o.querySelector('input[data-role="pan"]').value),u=o.querySelector('input[data-role="amp"]');u&&(u.value="0.2"),n.push({freq:he(i),decay:r,amp:.2,pan:s})}a&&a.setAllBranches(n),P()}function P(){const t=e=>document.getElementById(e);t("noiseLevel")&&(t("noiseLevelVal").textContent=Number(t("noiseLevel").value).toFixed(2)),t("rmixVal").textContent=Number(t("rmix").value).toFixed(2),t("nbranchesVal").textContent=t("nbranches").value,t("freqScaleVal").textContent=Number(t("freqScale").value).toFixed(2),t("octaves")&&(t("octavesVal").textContent=String(parseInt(t("octaves").value,10))),t("burstRate")&&(t("burstRateVal").textContent=Number(t("burstRate").value).toFixed(2)),t("burstDurMs")&&(t("burstDurMsVal").textContent=t("burstDurMs").value),t("impulseGain")&&(t("impulseGainVal").textContent=Number(t("impulseGain").value).toFixed(2)),t("exciterHP")&&(t("exciterHPVal").textContent=t("exciterHP").value),t("freqCenterVal").textContent=t("freqCenter").value,t("decayScaleVal").textContent=Number(t("decayScale").value).toFixed(2),t("groupSplit")&&(t("groupSplitVal").textContent=String(parseInt(t("groupSplit").value,10))),t("exciterBandQNoise")&&(t("exciterBandQNoiseVal").textContent=t("exciterBandQNoise").value),t("exciterBandQRain")&&(t("exciterBandQRainVal").textContent=t("exciterBandQRain").value),t("rainRate")&&(t("rainRateVal").textContent=Number(t("rainRate").value).toFixed(2)),t("rainDurMs")&&(t("rainDurMsVal").textContent=t("rainDurMs").value),t("rainGain")&&(t("rainGainVal").textContent=Number(t("rainGain").value).toFixed(2)),t("rainSpread")&&(t("rainSpreadVal").textContent=Number(t("rainSpread").value).toFixed(2)),t("rainCenter")&&(t("rainCenterVal").textContent=Number(t("rainCenter").value).toFixed(2)),t("rainLimbs")&&(t("rainLimbsVal").textContent=t("rainLimbs").value)}async function ze(){if(m)return;m=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100,latencyHint:"playback"}),a=await X.create(m);const t=m.createGain();t.gain.value=1;const e=m.createDynamicsCompressor();e.threshold.value=-18,e.knee.value=12,e.ratio.value=2,e.attack.value=.01,e.release.value=.25;const n=m.createGain();n.gain.value=1;let l=!1;function o(){try{t.disconnect()}catch{}try{e.disconnect()}catch{}try{n.disconnect()}catch{}l?t.connect(m.destination):(t.connect(e),e.connect(n),n.connect(m.destination))}o();const i=m.createGain();i.gain.value=1;const r=m.createGain();r.gain.value=1,a.connect(i,0,0),a.connect(r,1,0),i.connect(t),r.connect(t);const s=m.createAnalyser();s.fftSize=1024;const u=m.createAnalyser();u.fftSize=1024,i.connect(s),r.connect(u);const p=new Float32Array(s.fftSize),f=new Float32Array(u.fftSize),b=()=>{const d=document.getElementById("meter0Bar"),c=document.getElementById("meter1Bar");if(d&&c){s.getFloatTimeDomainData(p),u.getFloatTimeDomainData(f);let h=0;for(let R=0;R<p.length;R+=1)h+=p[R]*p[R];let B=0;for(let R=0;R<f.length;R+=1)B+=f[R]*f[R];const q=Math.sqrt(h/p.length),Be=Math.sqrt(B/f.length),Se=20*Math.log10(Math.max(1e-6,q)),Te=20*Math.log10(Math.max(1e-6,Be)),Ce=Math.max(0,Math.min(1,(Se+60)/60)),ke=Math.max(0,Math.min(1,(Te+60)/60));d.style.height=String(Math.round(Ce*100))+"%",c.style.height=String(Math.round(ke*100))+"%"}requestAnimationFrame(b)};requestAnimationFrame(b);let g=1,S=1;window._mixerApi={setCompressorParams(d){const c=d||{};typeof c.thresholdDb=="number"&&e.threshold.setTargetAtTime(c.thresholdDb,m.currentTime,.01),typeof c.kneeDb=="number"&&e.knee.setTargetAtTime(Math.max(0,Math.min(40,c.kneeDb)),m.currentTime,.01),typeof c.ratio=="number"&&e.ratio.setTargetAtTime(Math.max(1,Math.min(20,c.ratio)),m.currentTime,.01),typeof c.attack=="number"&&e.attack.setTargetAtTime(Math.max(.001,Math.min(1,c.attack)),m.currentTime,.01),typeof c.release=="number"&&e.release.setTargetAtTime(Math.max(.01,Math.min(2,c.release)),m.currentTime,.01)},getCompressorParams(){return{thresholdDb:e.threshold.value,kneeDb:e.knee.value,ratio:e.ratio.value,attack:e.attack.value,release:e.release.value}},setMakeupGain(d){const c=typeof d=="number"?Math.max(0,Math.min(4,d)):1;n.gain.setTargetAtTime(c,m.currentTime,.01)},getMakeupGain(){return n.gain.value},setCompressorBypass(d){l=!!d,o()},getCompressorBypass(){return l},getContext:()=>m,getNode:()=>a,getMasterOut:()=>t,getNoiseGain:()=>i,getRainGain:()=>r,muteMainStereo(d){d?(g=i.gain.value,S=r.gain.value,i.gain.setTargetAtTime(0,m.currentTime,.02),r.gain.setTargetAtTime(0,m.currentTime,.02)):(i.gain.setTargetAtTime(g,m.currentTime,.02),r.gain.setTargetAtTime(S,m.currentTime,.02))}},console.info("AudioContext started",{sampleRate:m.sampleRate,baseLatency:m.baseLatency});const y=d=>document.getElementById(d),T=["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupSplit"],M=["noiseType","lfoRate","lfoDepth","exciterCutoff","exciterHP","exciterBandQNoise","exciterBandQRain","rainRate","rainDurMs","rainGain","rainSpread","rainCenter","rainLimbs"];for(const d of M)document.getElementById(d)&&T.push(d);T.forEach(d=>{const c=y(d);c&&c.addEventListener("input",()=>{if(P(),J({[d]:c.type==="checkbox"?!!c.checked:d==="nbranches"||d==="octaves"||d==="groupSplit"?parseInt(c.value,10):parseFloat(c.value)}),!a)return;const h=m.currentTime;switch(d){case"noiseLevel":a.noiseLevel.setValueAtTime(parseFloat(c.value),h);break;case"noiseType":a.noiseType.setValueAtTime(parseInt(c.value,10),h);break;case"rmix":a.rmix.setValueAtTime(parseFloat(c.value),h);break;case"nbranches":{const B=parseInt(c.value,10);a.nbranches.setValueAtTime(B,h),U(B);const q=document.getElementById("groupSplit");q&&(q.max=String(B),parseInt(q.value,10)>B&&(q.value=String(B))),B>z&&Ge(z,B),z=B;break}case"freqScale":a.freqScale.setValueAtTime(parseFloat(c.value),h);break;case"octaves":a.octaves.setValueAtTime(parseInt(c.value,10),h);break;case"exciterCutoff":a.exciterCutoff.setValueAtTime(parseFloat(c.value),h);break;case"exciterHP":a.exciterHP.setValueAtTime(parseFloat(c.value),h);break;case"burstRate":a.burstRate.setValueAtTime(parseFloat(c.value),h);break;case"burstDurMs":a.burstDurMs.setValueAtTime(parseFloat(c.value),h);break;case"impulseGain":a.impulseGain.setValueAtTime(parseFloat(c.value),h);break;case"freqCenter":a.freqCenter.setValueAtTime(parseFloat(c.value),h);break;case"decayScale":a.decayScale.setValueAtTime(parseFloat(c.value),h);break;case"exciterBandQNoise":a.exciterBandQNoise.setValueAtTime(parseFloat(c.value),h);break;case"exciterBandQRain":a.exciterBandQRain.setValueAtTime(parseFloat(c.value),h);break;case"groupSplit":a.groupSplit.setValueAtTime(parseInt(c.value,10),h);break}})});const C=document.getElementById("groupEnabled");C&&C.addEventListener("change",()=>{a&&(J({groupEnabled:!!C.checked}),a.groupEnabled.setValueAtTime(C.checked?1:0,m.currentTime))});const v=document.getElementById("rainEnabled");v&&v.addEventListener("change",()=>{a&&a.rainEnabled.setValueAtTime(v.checked?1:0,m.currentTime)});const A=document.getElementById("lfoEnabled");A&&A.addEventListener("change",()=>{a&&a.lfoEnabled.setValueAtTime(A.checked?1:0,m.currentTime)});const L=document.getElementById("lfoWave");L&&L.addEventListener("change",()=>{a&&a.lfoWave.setValueAtTime(parseInt(L.value,10),m.currentTime)});const E=document.getElementById("monitorExciter");E&&E.addEventListener("change",()=>{a&&a.monitorExciter.setValueAtTime(E.checked?1:0,m.currentTime)});const x=document.getElementById("scaleRoot"),k=document.getElementById("scaleName"),I=()=>{if(!a)return;const d=k.value,c=x.value;J({scaleName:d,scaleRoot:c}),a.setScale({name:d,root:c}),a.quantize.setValueAtTime(d==="off"?0:1,m.currentTime)};x.addEventListener("change",I),k.addEventListener("change",I);const F=parseInt(document.getElementById("nbranches").value,10)||16;a.nbranches.setValueAtTime(F,m.currentTime),U(F),z=F,(function(){x&&k&&I()})(),ve();try{const d=document.getElementById("randomizeBtn");d&&d.click()}catch{}_()}const re=document.getElementById("branches");if(re)for(let t=0;t<D;t+=1)re.appendChild(De(t));const ie=document.getElementById("startBtn");ie&&ie.addEventListener("click",ze);const oe=document.getElementById("randomizeBtn");oe&&oe.addEventListener("click",()=>{const t=parseInt(document.getElementById("nbranches").value,10)||16;qe();const e=parseInt(document.getElementById("nbranches").value,10)||t;we(e);const n=document.getElementById("scaleRoot"),l=document.getElementById("scaleName"),o=te($()||ee());if(!(o.scaleRoot&&o.scaleRoot.enabled||o.scaleName&&o.scaleName.enabled)&&n&&l){const r=Array.from(n.options).map(g=>g.value),s=Array.from(l.options).map(g=>g.value),u=s.filter(g=>g!=="off"),p=g=>g[Math.floor(Math.random()*g.length)],f=p(r),b=p(u.length?u:s);n.value=f,l.value=b,n.dispatchEvent(new Event("change",{bubbles:!0})),l.dispatchEvent(new Event("change",{bubbles:!0}))}try{if(typeof BroadcastChannel<"u"){const r=new BroadcastChannel("spatial");let s=null;try{const u=document.getElementById("randMaxDist");u&&(s=parseFloat(u.value))}catch{}r.postMessage({type:"randomizePositions",radius:s})}}catch{}});const le=document.getElementById("resetBtn");le&&le.addEventListener("click",()=>{try{localStorage.removeItem(O),localStorage.removeItem(Q)}catch{}document.getElementById("noiseLevel")&&(document.getElementById("noiseLevel").value="0.03"),document.getElementById("rmix").value="1",document.getElementById("nbranches").value="4",document.getElementById("freqScale").value="1",document.getElementById("octaves").value="0",document.getElementById("exciterCutoff")&&(document.getElementById("exciterCutoff").value="4000"),document.getElementById("exciterHP")&&(document.getElementById("exciterHP").value="50"),document.getElementById("noiseType")&&(document.getElementById("noiseType").value="0"),document.getElementById("lfoEnabled")&&(document.getElementById("lfoEnabled").checked=!0),document.getElementById("lfoRate")&&(document.getElementById("lfoRate").value="0.10"),document.getElementById("lfoDepth")&&(document.getElementById("lfoDepth").value="0.56"),document.getElementById("lfoWave")&&(document.getElementById("lfoWave").value="0"),document.getElementById("rainEnabled")&&(document.getElementById("rainEnabled").checked=!0),document.getElementById("rainRate")&&(document.getElementById("rainRate").value="0.81"),document.getElementById("rainDurMs")&&(document.getElementById("rainDurMs").value="8"),document.getElementById("rainGain")&&(document.getElementById("rainGain").value="0.85"),document.getElementById("rainSpread")&&(document.getElementById("rainSpread").value="0.69"),document.getElementById("rainCenter")&&(document.getElementById("rainCenter").value="0.55"),document.getElementById("rainLimbs")&&(document.getElementById("rainLimbs").value="9"),document.getElementById("monitorExciter")&&(document.getElementById("monitorExciter").checked=!1),document.getElementById("freqCenter").value="0",document.getElementById("decayScale").value="1",document.getElementById("groupEnabled")&&(document.getElementById("groupEnabled").checked=!1),document.getElementById("groupSplit")&&(document.getElementById("groupSplit").value="0");const t=document.getElementById("exciterBandQNoise");t&&(t.value="30");const e=document.getElementById("exciterBandQRain");if(e&&(e.value="30"),document.getElementById("scaleRoot")&&(document.getElementById("scaleRoot").value="A"),document.getElementById("scaleName")&&(document.getElementById("scaleName").value="off"),P(),a&&m){const n=m.currentTime;a.noiseLevel.setValueAtTime(.03,n),a.noiseType&&a.noiseType.setValueAtTime(1,n),a.lfoEnabled&&a.lfoEnabled.setValueAtTime(1,n),a.lfoRate&&a.lfoRate.setValueAtTime(.1,n),a.lfoDepth&&a.lfoDepth.setValueAtTime(.56,n),a.lfoWave&&a.lfoWave.setValueAtTime(0,n),a.rmix.setValueAtTime(1,n),a.nbranches.setValueAtTime(4,n),a.freqScale.setValueAtTime(1,n),a.octaves.setValueAtTime(0,n),a.exciterCutoff&&a.exciterCutoff.setValueAtTime(4e3,n),a.exciterHP&&a.exciterHP.setValueAtTime(50,n),a.rainEnabled&&a.rainEnabled.setValueAtTime(1,n),a.rainRate&&a.rainRate.setValueAtTime(.83,n),a.rainDurMs&&a.rainDurMs.setValueAtTime(61,n),a.rainGain&&a.rainGain.setValueAtTime(.62,n),a.rainSpread&&a.rainSpread.setValueAtTime(.71,n),a.rainCenter&&a.rainCenter.setValueAtTime(.49,n),a.rainLimbs&&a.rainLimbs.setValueAtTime(10,n),a.monitorExciter&&a.monitorExciter.setValueAtTime(0,n),a.freqCenter.setValueAtTime(0,n),a.decayScale.setValueAtTime(1,n),a.groupEnabled&&a.groupEnabled.setValueAtTime(0,n),a.groupSplit&&a.groupSplit.setValueAtTime(0,n),a.quantize.setValueAtTime(0,n),a.setScale&&a.setScale({name:"off",root:"A"}),U(4),z=4}ve(),_()});document.getElementById("rmix")&&P();Le();const se=document.getElementById("openControlsBtn");se&&se.addEventListener("click",()=>{window.open("control.html","Exciter Controls")});const ce=document.getElementById("openMixerBtn");ce&&ce.addEventListener("click",()=>{window.open("mixer.html","Mixer")});const de=document.getElementById("openRandomizerBtn");de&&de.addEventListener("click",()=>{window.open("randomizer.html","Randomizer")});const ue=document.getElementById("openSpatialBtn");ue&&ue.addEventListener("click",()=>{window.open("spatial.html","Spatializer")});document.getElementById("randomizerPanel")&&Ne();(function(){try{Ae()}catch{}try{const e=fe();if(e)for(const[n,l]of Object.entries(e))H(n,l)}catch{}})();
