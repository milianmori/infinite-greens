import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import*as M from"https://unpkg.com/three@0.160.0/build/three.module.js";import{OrbitControls as le}from"https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";import{CSS2DRenderer as de,CSS2DObject as ue}from"https://unpkg.com/three@0.160.0/examples/jsm/renderers/CSS2DRenderer.js";class K{static async create(t,e,n){try{const a=new URL("data:text/javascript;base64,dmFyIFA9KHkscyk9PigpPT4oc3x8eSgocz17ZXhwb3J0czp7fX0pLmV4cG9ydHMscykscy5leHBvcnRzKTt2YXIgUz1QKCgpPT57dmFyIGY9Y2xhc3MgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3J7Y29uc3RydWN0b3IoKXtzdXBlcigpLHRoaXMubm9pc2VEZWxheXM9WzEwMSwxMjddO2xldCBzPW89Pih7YnVmOm5ldyBGbG9hdDMyQXJyYXkobyksaWR4OjAsbGVuOm99KTt0aGlzLm5vaXNlQnVmcz10aGlzLm5vaXNlRGVsYXlzLm1hcChvPT5zKG8pKSx0aGlzLm1ldGVyQWNjdW09bmV3IEZsb2F0NjRBcnJheSg3KSx0aGlzLm1ldGVyQ291bnQ9MCx0aGlzLnBvcnQub25tZXNzYWdlPW89PntsZXQgZT1vLmRhdGF8fHt9O2UmJmUucmVzZXRNZXRlcnMmJih0aGlzLm1ldGVyQWNjdW0uZmlsbCgwKSx0aGlzLm1ldGVyQ291bnQ9MCl9fXN0YXRpYyBnZXQgcGFyYW1ldGVyRGVzY3JpcHRvcnMoKXtyZXR1cm5bXX1wcm9jZXNzKHMsbyl7bGV0IGU9b1swXTtpZighZXx8ZS5sZW5ndGg8NylyZXR1cm4hMDtsZXQgaT1zWzBdfHxbXSx3PXNbMV18fFtdLEY9d1swXXx8bmV3IEZsb2F0MzJBcnJheSgxMjgpLHA9d1sxXXx8bmV3IEZsb2F0MzJBcnJheSgxMjgpLGc9ZVswXSxiPWVbMV0sQj1lWzJdLEQ9ZVszXSxrPWVbNF0sdj1lWzVdLE49ZVs2XSxjPWcubGVuZ3RoO2ZvcihsZXQgdD0wO3Q8Yzt0Kz0xKXtsZXQgcj0oaVswXXx8bmV3IEZsb2F0MzJBcnJheShjKSlbdF18fDAsYT0oaVsxXXx8bmV3IEZsb2F0MzJBcnJheShjKSlbdF18fDAsbD0oaVsyXXx8bmV3IEZsb2F0MzJBcnJheShjKSlbdF18fDAsQT0oaVszXXx8bmV3IEZsb2F0MzJBcnJheShjKSlbdF18fDAsZD0oaVs0XXx8bmV3IEZsb2F0MzJBcnJheShjKSlbdF18fDAsUj0oRlt0XStwW3RdKSouNSxxPShGW3RdLXBbdF0pKi41LGg9MCx1PTA7Zm9yKGxldCBtPTA7bTwyO20rPTEpe2xldCBuPXRoaXMubm9pc2VCdWZzW21dLHg9LjcrLjIqbSxJPTEteCxMPXgqUitJKnE7bi5idWZbbi5pZHhdPUw7bGV0IEM9KG4uaWR4KzEpJW4ubGVuLE09bi5idWZbQ107bi5pZHg9QyxtPT09MD9oPU06dT1NfWdbdF09cixiW3RdPWEsQlt0XT1sLERbdF09QSxrW3RdPWQsdlt0XT1oLE5bdF09dSx0aGlzLm1ldGVyQWNjdW1bMF0rPXIqcix0aGlzLm1ldGVyQWNjdW1bMV0rPWEqYSx0aGlzLm1ldGVyQWNjdW1bMl0rPWwqbCx0aGlzLm1ldGVyQWNjdW1bM10rPUEqQSx0aGlzLm1ldGVyQWNjdW1bNF0rPWQqZCx0aGlzLm1ldGVyQWNjdW1bNV0rPWgqaCx0aGlzLm1ldGVyQWNjdW1bNl0rPXUqdX1pZih0aGlzLm1ldGVyQ291bnQrPWMsdGhpcy5tZXRlckNvdW50PjApe2xldCB0PW5ldyBGbG9hdDMyQXJyYXkoNyk7Zm9yKGxldCByPTA7cjw3O3IrPTEpe2xldCBhPU1hdGguc3FydCh0aGlzLm1ldGVyQWNjdW1bcl0vdGhpcy5tZXRlckNvdW50KXx8MDt0W3JdPWEsdGhpcy5tZXRlckFjY3VtW3JdPTB9dGhpcy5tZXRlckNvdW50PTAsdGhpcy5wb3J0LnBvc3RNZXNzYWdlKHt0eXBlOiJtZXRlcnMiLHJtczp0fSl9cmV0dXJuITB9fTtyZWdpc3RlclByb2Nlc3Nvcigic3BhdGlhbC1wcm9jZXNzb3IiLGYpfSk7ZXhwb3J0IGRlZmF1bHQgUygpOwo=",import.meta.url).href;await t.audioWorklet.addModule(a)}catch{}return new K(t,e,n)}constructor(t,e,n){this.context=t,this.resNode=e,this.destination=n,this.enabled=!1,this.bypass=!1,this.params={refDistance:1,rolloffFactor:1,maxDistance:10,coneInner:360,coneOuter:360,coneOuterGain:0},this.sources=new Array(7).fill(null).map((a,i)=>({x:(i-3)*.5,y:0,z:-2-.2*i,gain:i===5||i===6?.3:1,solo:!1})),this.listener={x:-5.22,y:-.81,z:-7.69},this.reverbParams={wet:.05,decayTime:1.5,gainDb:0,hfDampHz:6e3},this.reverbExclude=new Array(7).fill(!1),this.reverbScale=new Array(7).fill(1),this._buildGraph()}_buildGraph(){const t=this.context;this.worklet=new AudioWorkletNode(t,"spatial-processor",{numberOfInputs:2,numberOfOutputs:1,outputChannelCount:[7],channelCount:5,channelCountMode:"clamped-max",channelInterpretation:"speakers"}),this.worklet.port.onmessage=e=>{const n=e.data||{};if(n.type==="meters"&&this._meterSink)try{this._meterSink(n.rms)}catch{}},this.splitter=t.createChannelSplitter(7),this.worklet.connect(this.splitter),this.spatialMaster=t.createGain(),this.spatialMaster.gain.value=1,this.spatialMaster.connect(this.destination),this._initReverbBus(),this.sourceGains=new Array(7),this.panners=new Array(7),this.reverbSends=new Array(7);for(let e=0;e<7;e+=1){const n=t.createGain();n.gain.value=this.sources[e].gain,this.sourceGains[e]=n;const a=t.createPanner();a.panningModel="HRTF",a.distanceModel="inverse",a.refDistance=this.params.refDistance,a.rolloffFactor=this.params.rolloffFactor,a.maxDistance=this.params.maxDistance,a.coneInnerAngle=this.params.coneInner,a.coneOuterAngle=this.params.coneOuter,a.coneOuterGain=this.params.coneOuterGain,a.positionX.value=this.sources[e].x,a.positionY.value=this.sources[e].y,a.positionZ.value=this.sources[e].z,this.panners[e]=a,this.splitter.connect(n,e),n.connect(a),a.connect(this.spatialMaster);const i=t.createGain();i.gain.value=0,this.reverbSends[e]=i,a.connect(i),i.connect(this._reverb.pre)}this._directNoiseToDest=null,this._directRainToDest=null,this._meterSink=null,this.enabled=!0;try{this.resNode.connect(this.worklet,2,0)}catch{}try{this.resNode.connect(this.worklet,0,1)}catch{}try{this._updateReverbSends()}catch{}}_initReverbBus(){const t=this.context,e={};e.pre=t.createGain(),e.pre.gain.value=1,e.erSum=t.createGain(),e.erSum.gain.value=1,e.erLPF=t.createBiquadFilter(),e.erLPF.type="lowpass",e.erLPF.frequency.value=8e3;const n=[.012,.021,.034],a=[.5,.35,.25];e.taps=n.map((i,c)=>{const s=t.createDelay(.1);s.delayTime.value=i;const u=t.createGain();return u.gain.value=a[c],e.erLPF.connect(s),s.connect(u),u.connect(e.erSum),{d:s,g:u}}),e.erLPF.connect(e.erSum),e.convolver=t.createConvolver(),e.convolver.normalize=!1,e.postLPF=t.createBiquadFilter(),e.postLPF.type="lowpass",e.postLPF.frequency.value=this.reverbParams.hfDampHz,e.wetGain=t.createGain(),e.wetGain.gain.value=this.reverbParams.wet,e.outGain=t.createGain(),e.outGain.gain.value=this._dbToGain(this.reverbParams.gainDb),e.pre.connect(e.erLPF),e.erSum.connect(e.convolver),e.convolver.connect(e.postLPF),e.postLPF.connect(e.wetGain),e.wetGain.connect(e.outGain),e.outGain.connect(this.destination),e.convolver.buffer=this._generateStereoIR(this.reverbParams.decayTime,this.reverbParams.hfDampHz),this._reverb=e}_dbToGain(t){return Math.pow(10,(t||0)/20)}_generateStereoIR(t,e){const n=this.context,a=n.sampleRate||44100,i=Math.max(1,Math.floor(a*Math.max(.1,Math.min(10,t)))),c=n.createBuffer(2,i,a),s=Math.max(.001,t)/3,u=Math.exp(-1/(a*s)),y=Math.max(200,Math.min(2e4,e||6e3)),g=1/(2*Math.PI*y),v=1/(1+a*g);for(let x=0;x<2;x+=1){const z=c.getChannelData(x);let G=0,w=1;for(let S=0;S<i;S+=1){const _=(Math.random()*2-1)*(x===0?1:.97);G+=v*(_-G),w*=u,z[S]=G*w}}return c}_updateReverbSends(){const t=this.listener,e=Math.max(.001,this.params.refDistance),n=Math.max(e+.001,this.params.maxDistance),a=this.context.currentTime;for(let i=0;i<7;i+=1){const c=this.sources[i],s=c.x-t.x,u=c.y-t.y,y=c.z-t.z;let v=(Math.sqrt(s*s+u*u+y*y)-e)/(n-e);v<0?v=0:v>1&&(v=1);let x=Math.pow(v,.7)*Math.max(0,c.gain);this.reverbExclude[i]?x=0:x*=Math.max(0,this.reverbScale&&this.reverbScale[i]!=null?this.reverbScale[i]:1);try{this.reverbSends[i].gain.setTargetAtTime(x,a,.05)}catch{this.reverbSends[i].gain.value=x}}}setReverbExclude(t,e){const n=t|0;n<0||n>=7||(this.reverbExclude[n]=!!e,this._updateReverbSends())}setReverbScale(t,e){const n=t|0;if(n<0||n>=7)return;const a=Number(e);this.reverbScale[n]=isFinite(a)?Math.max(0,Math.min(2,a)):1,this._updateReverbSends()}setReverbParams(t){this.reverbParams={...this.reverbParams,...t||{}};const e=this.reverbParams,n=this.context.currentTime;try{this._reverb.wetGain.gain.setTargetAtTime(Math.max(0,Math.min(1,e.wet)),n,.02)}catch{this._reverb.wetGain.gain.value=Math.max(0,Math.min(1,e.wet))}try{this._reverb.postLPF.frequency.setTargetAtTime(Math.max(200,Math.min(2e4,e.hfDampHz)),n,.02)}catch{this._reverb.postLPF.frequency.value=Math.max(200,Math.min(2e4,e.hfDampHz))}try{this._reverb.outGain.gain.setTargetAtTime(this._dbToGain(Math.max(0,Math.min(12,e.gainDb))),n,.02)}catch{this._reverb.outGain.gain.value=this._dbToGain(Math.max(0,Math.min(12,e.gainDb)))}try{this._reverb.convolver.buffer=this._generateStereoIR(e.decayTime,e.hfDampHz)}catch{}}setListenerPose(t){!t||!t.position||(this.listener.x=Number(t.position.x)||0,this.listener.y=Number(t.position.y)||0,this.listener.z=Number(t.position.z)||0,this._updateReverbSends())}setBypass(t){this.bypass=!!t;const e=this.bypass?0:1;try{this.spatialMaster.gain.setTargetAtTime(e,this.context.currentTime,.02)}catch{this.spatialMaster.gain.value=e}try{this._reverb.outGain.gain.setTargetAtTime(e*this._dbToGain(this.reverbParams.gainDb),this.context.currentTime,.02)}catch{}}setMeterSink(t){this._meterSink=t}setSource(t,{x:e,y:n,z:a,gain:i,solo:c}){const s=t|0;if(s<0||s>=7)return;const u=this.sources[s];typeof e=="number"&&(u.x=e,this.panners[s].positionX.value=e),typeof n=="number"&&(u.y=n,this.panners[s].positionY.value=n),typeof a=="number"&&(u.z=a,this.panners[s].positionZ.value=a),typeof i=="number"&&(u.gain=i,this.sourceGains[s].gain.value=i),typeof c=="boolean"&&(u.solo=c,this._applySolo()),this._updateReverbSends()}_applySolo(){const t=this.sources.some(e=>e.solo);for(let e=0;e<7;e+=1)this.sourceGains[e].gain.value=t?this.sources[e].solo?this.sources[e].gain:0:this.sources[e].gain}setGlobal(t){Object.assign(this.params,t||{});for(let e=0;e<7;e+=1){const n=this.panners[e];n.refDistance=this.params.refDistance,n.rolloffFactor=this.params.rolloffFactor,n.maxDistance=this.params.maxDistance,n.coneInnerAngle=this.params.coneInner,n.coneOuterAngle=this.params.coneOuter,n.coneOuterGain=this.params.coneOuterGain}this._updateReverbSends()}randomizePositions(t){const e=t&&typeof t.radius=="number"?Math.max(.01,t.radius):3;for(let n=0;n<7;n+=1){let a,i,c;for(;;){const u=Math.random()*2-1,y=Math.random()*2-1,g=u*u+y*y;if(g>=1||g===0)continue;const v=Math.sqrt(1-g);if(a=2*u*v,i=2*y*v,c=1-2*g,c<=0)break}c=-Math.abs(c);const s=e*Math.sqrt(Math.random());this.setSource(n,{x:a*s,y:i*s*.5,z:c*s-.5})}}destroy(){try{this.worklet.disconnect()}catch{}try{this.splitter.disconnect()}catch{}for(let t=0;t<7;t+=1){try{this.sourceGains[t].disconnect()}catch{}try{this.panners[t].disconnect()}catch{}try{this.reverbSends[t].disconnect()}catch{}}try{this._reverb.outGain.disconnect()}catch{}try{this._reverb.postLPF.disconnect()}catch{}try{this._reverb.convolver.disconnect()}catch{}try{this._reverb.erSum.disconnect()}catch{}try{this._reverb.pre.disconnect()}catch{}this.enabled=!1}}let $=null,p=null,E=null;const te=new BroadcastChannel("spatial");te.onmessage=async l=>{const t=l.data||{};if(t.type==="randomizePositions"){const e=typeof t.radius=="number"?t.radius:parseFloat((d("maxDistance")||{value:"10"}).value);p&&p.randomizePositions({radius:e})}};function d(l){return document.getElementById(l)}function ne(l){const t=parseFloat(l.step||"1");let e=0;if(t<1){const n=String(t).split(".")[1];e=Math.min(3,n?n.length:2)}return(l.id==="listenerYaw"||l.id==="listenerPitch")&&(e=0),Number(l.value).toFixed(e)}function he(l){if(!l)return null;const t=l.querySelector('input[type="range"]');if(!t)return null;let e=l.querySelector(".sp-val");e||(e=document.createElement("span"),e.className="sp-val",l.insertBefore(e,t));const n=()=>{e.textContent=ne(t)};return t.addEventListener("input",n),n(),e}function pe(){Array.from(document.querySelectorAll(".sp-card label")).forEach(he)}function ae(){const l=Array.from(document.querySelectorAll(".sp-card label"));for(const t of l){const e=t.querySelector('input[type="range"]'),n=t.querySelector(".sp-val");e&&n&&(n.textContent=ne(e))}}function se(){const l=parseFloat(d("listenerX").value),t=parseFloat(d("listenerY").value),e=parseFloat(d("listenerZ").value),n=parseFloat(d("listenerYaw").value),a=parseFloat(d("listenerPitch").value),i=n*Math.PI/180,c=a*Math.PI/180,s=Math.cos(c)*Math.sin(i),u=Math.sin(c),y=-Math.cos(c)*Math.cos(i);return{position:{x:l,y:t,z:e},forward:{x:s,y:u,z:y}}}function me(l){if(!l)return null;const t=new M.Scene;t.background=null;const e=l.clientWidth||600,n=l.clientHeight||400,a=new M.PerspectiveCamera(60,e/n,.1,1e3);a.position.set(5,3,6);const i=new M.WebGLRenderer({antialias:!0,alpha:!0});i.setPixelRatio(Math.min(window.devicePixelRatio||1,2)),i.setSize(e,n),l.appendChild(i.domElement);const c=new de;c.setSize(e,n),c.domElement.style.position="absolute",c.domElement.style.left="0",c.domElement.style.top="0",c.domElement.style.pointerEvents="none",l.appendChild(c.domElement);const s=new le(a,i.domElement);s.enableDamping=!0,s.target.set(0,0,-3);const u=new M.GridHelper(20,20,3359061,2042167);u.position.y=-.001,t.add(u);const y=new M.AxesHelper(1.5);t.add(y);const g=new M.AmbientLight(16777215,.4);t.add(g);const v=new M.DirectionalLight(16777215,.6);v.position.set(3,5,4),t.add(v);const x=[],z=6333946,G=2278750,w=15680580,S=f=>{const b=document.createElement("div");return b.className="sp-label",b.textContent=f,new ue(b)};for(let f=0;f<7;f+=1){const b=new M.SphereGeometry(.12,24,16),T=f===5?G:f===6?w:z,V=new M.MeshPhongMaterial({color:T}),X=new M.Mesh(b,V),I=S(String(f+1));I.position.set(0,.22,0),X.add(I),t.add(X),x.push({mesh:X})}const _=new M.SphereGeometry(.14,24,16),R=new M.MeshPhongMaterial({color:16498468}),D=new M.Mesh(_,R);t.add(D);const W=new M.ArrowHelper(new M.Vector3(0,0,-1),new M.Vector3(0,0,0),.9,16498468);t.add(W);function C(f,b){const T=x[f];!T||!b||T.mesh.position.set(b.x,b.y,b.z)}function Z(f){if(!f)return;D.position.set(f.position.x,f.position.y,f.position.z);const b=new M.Vector3(f.forward.x,f.forward.y,f.forward.z);b.lengthSq()>1e-6?b.normalize():b.set(0,0,-1),W.setDirection(b),W.position.copy(D.position)}function L(){const f=l.clientWidth||600,b=l.clientHeight||400;a.aspect=f/b,a.updateProjectionMatrix(),i.setSize(f,b),c.setSize(f,b)}window.addEventListener("resize",L);const B=new ResizeObserver(()=>L());try{B.observe(l)}catch{}function A(){s.update(),i.render(t,a),c.render(t,a),requestAnimationFrame(A)}return A(),{updateSource:C,updateListener:Z,resize:L}}function fe(){const l=d("sources");l.innerHTML="";for(let t=0;t<7;t+=1){const e=document.createElement("div");e.className="sp-row";const n=document.createElement("span");n.textContent=String(t+1),e.appendChild(n);const a=document.createElement("input");a.type="range",a.min="-5",a.max="5",a.step="0.01",a.title="X position",a.setAttribute("aria-label","X position");const i=document.createElement("input");i.type="range",i.min="-3",i.max="3",i.step="0.01",i.title="Y position",i.setAttribute("aria-label","Y position");const c=document.createElement("input");c.type="range",c.min="-10",c.max="0",c.step="0.01",c.title="Z position",c.setAttribute("aria-label","Z position");const s=document.createElement("input");s.type="range",s.min="0",s.max="2",s.step="0.01",s.value=t===5||t===6?"0.3":"1",s.title="Gain",s.setAttribute("aria-label","Gain");const u=document.createElement("input");u.type="checkbox",u.title="Solo",u.setAttribute("aria-label","Solo");const y=document.createElement("label");y.textContent="X ",y.appendChild(a);const g=document.createElement("label");g.textContent="Y ",g.appendChild(i);const v=document.createElement("label");v.textContent="Z ",v.appendChild(c);const x=document.createElement("label");x.textContent="Gain ",x.appendChild(s);const z=document.createElement("label");z.appendChild(u),z.appendChild(document.createTextNode(" Solo")),a.value=String((t-3)*.8),i.value="0",c.value=String(-3-t*.3);const G=()=>{p&&p.setSource(t,{x:parseFloat(a.value),y:parseFloat(i.value),z:parseFloat(c.value),gain:parseFloat(s.value)})},w=()=>{p&&p.setSource(t,{solo:!!u.checked})};[a,i,c,s].forEach(S=>S.addEventListener("input",G)),u.addEventListener("change",w),e.appendChild(y),e.appendChild(g),e.appendChild(v),e.appendChild(x),e.appendChild(z),l.appendChild(e)}}function ye(){["refDistance","rolloffFactor","maxDistance","coneInner","coneOuter","coneOuterGain"].forEach(r=>{const h=d(r);h&&h.addEventListener("input",()=>{if(!p)return;const o={};o[r==="coneInner"?"coneInner":r]=parseFloat(h.value),p.setGlobal(o)})});const t=(r,h,o)=>{const m=d(r);m&&m.addEventListener("input",()=>{if(!p)return;const P=parseFloat(m.value);p.setReverbParams({[h]:P})})};t("rvWet","wet"),t("rvDecay","decayTime"),t("rvGainDb","gainDb"),t("rvHf","hfDampHz");const e=d("rvScale6"),n=d("rvScale7");e&&e.addEventListener("input",()=>{try{p&&p.setReverbScale(5,parseFloat(e.value))}catch{}}),n&&n.addEventListener("input",()=>{try{p&&p.setReverbScale(6,parseFloat(n.value))}catch{}});const a=["listenerX","listenerY","listenerZ","listenerYaw","listenerPitch"];let i=!1;const c=()=>{const r=se();try{const h=window.opener&&window.opener._mixerApi?window.opener._mixerApi.getContext():null;if(h&&h.listener){const o=h.listener,m=h.currentTime||0;o.positionX?(o.positionX.setTargetAtTime(r.position.x,m,.02),o.positionY.setTargetAtTime(r.position.y,m,.02),o.positionZ.setTargetAtTime(r.position.z,m,.02)):o.setPosition&&o.setPosition(r.position.x,r.position.y,r.position.z),o.forwardX&&o.upX?(o.forwardX.setTargetAtTime(r.forward.x,m,.02),o.forwardY.setTargetAtTime(r.forward.y,m,.02),o.forwardZ.setTargetAtTime(r.forward.z,m,.02),o.upX.setTargetAtTime(0,m,.02),o.upY.setTargetAtTime(1,m,.02),o.upZ.setTargetAtTime(0,m,.02)):o.setOrientation&&o.setOrientation(r.forward.x,r.forward.y,r.forward.z,0,1,0);try{p&&p.setListenerPose&&p.setListenerPose(r)}catch{}}}catch{}try{E&&E.updateListener(r)}catch{}};a.forEach(r=>{const h=d(r);h&&h.addEventListener("input",()=>{i||(V(),f()),c()})});const s={enabled:!1,speed:1,approach:.5,dwell:.3,yawEnabled:!0,yawRateDeg:120};let u=[],y=0,g=0,v=1,x=0,z=0,G=!1,w={x:parseFloat(d("listenerX").value),y:parseFloat(d("listenerY").value),z:parseFloat(d("listenerZ").value)},S=parseFloat(d("listenerYaw").value)*Math.PI/180,_=0,R=!1;function D(r,h){const o=Math.max(1e-4,r);return 1-Math.exp(-o*h*5)}function W(){const r=[];try{if(!p)return r;for(let h=0;h<7;h+=1){const o=p.sources[h];o&&r.push({x:o.x,y:o.y,z:o.z})}}catch{}return r}function C(){const r={x:0,y:0,z:0},h=W();h.sort((o,m)=>{const P=(o.x-r.x)*(o.x-r.x)+(o.y-r.y)*(o.y-r.y)+(o.z-r.z)*(o.z-r.z),N=(m.x-r.x)*(m.x-r.x)+(m.y-r.y)*(m.y-r.y)+(m.z-r.z)*(m.z-r.z);return P-N}),u=[r,...h],y=0,g=0,x=0,Z()}function Z(){if(!u.length)return;const r=u[y%u.length],h=u[(y+1)%u.length],o=h.x-r.x,m=h.y-r.y,P=h.z-r.z;v=Math.max(1e-4,Math.hypot(o,m,P))/Math.max(.001,s.speed)}function L(){i=!0;try{d("listenerX").value=String(w.x),d("listenerY").value=String(w.y),d("listenerZ").value=String(w.z),d("listenerYaw").value=String(Math.round(S*180/Math.PI))}catch{}try{c()}catch{}try{ae()}catch{}i=!1}function B(r){if(!R||!s.yawEnabled||s.enabled)return;_||(_=r);const h=Math.min(.1,Math.max(0,(r-_)/1e3));_=r;const o=Math.max(0,s.yawRateDeg)*Math.PI/180*h;for(S+=o;S>Math.PI;)S-=2*Math.PI;for(;S<-Math.PI;)S+=2*Math.PI;L(),requestAnimationFrame(B)}function A(){s.yawEnabled&&!s.enabled&&!R&&(R=!0,_=0,requestAnimationFrame(B))}function f(){R=!1}function b(r){if(!G||!s.enabled||!u.length)return;z||(z=r);const h=Math.min(.1,Math.max(0,(r-z)/1e3));z=r;const o={x:w.x,z:w.z};if(x>0){x-=h,L(),requestAnimationFrame(b);return}const m=u[y%u.length],P=u[(y+1)%u.length],N=P.x-m.x,oe=P.y-m.y,ce=P.z-m.z,Q=Math.min(1,g/Math.max(1e-4,v)),j=Q*Q*(3-2*Q),q={x:m.x+N*j,y:m.y+oe*j,z:m.z+ce*j},O=D(s.approach,h);if(w.x+=(q.x-w.x)*O,w.y+=(q.y-w.y)*O,w.z+=(q.z-w.z)*O,s.yawEnabled){const H=w.x-o.x,J=w.z-o.z;if(H*H+J*J>1e-8){let F=Math.atan2(H,-J)-S;for(;F>Math.PI;)F-=2*Math.PI;for(;F<-Math.PI;)F+=2*Math.PI;const Y=Math.max(0,s.yawRateDeg)*Math.PI/180*h;F>Y?F=Y:F<-Y&&(F=-Y),S+=F}}g+=h,g>=v&&(y=(y+1)%u.length,g=0,x=Math.max(0,s.dwell),Z()),L(),requestAnimationFrame(b)}function T(){if(s.enabled=!!d("autoMove").checked,!s.enabled)return V();C(),G=!0,z=0,f(),requestAnimationFrame(b)}function V(){s.enabled=!1,G=!1,s.yawEnabled&&A()}const X=(r,h)=>{const o=d(r);o&&o.addEventListener("input",()=>{s[h]=parseFloat(o.value),h==="speed"&&Z()})},I=(r,h)=>{const o=d(r);o&&o.addEventListener("change",()=>{s[h]=!!o.checked,r==="autoMove"&&(s.enabled=!!o.checked,s.enabled?T():V())})};I("autoMove","enabled"),X("autoSpeed","speed"),X("autoApproach","approach"),X("autoDwell","dwell"),I("autoYaw","yawEnabled"),X("autoYawRate","yawRateDeg");function ie(){try{s.enabled=!!(d("autoMove")&&d("autoMove").checked),s.speed=parseFloat((d("autoSpeed")||{value:String(s.speed)}).value),s.approach=parseFloat((d("autoApproach")||{value:String(s.approach)}).value),s.dwell=parseFloat((d("autoDwell")||{value:String(s.dwell)}).value),s.yawEnabled=!!(d("autoYaw")&&d("autoYaw").checked),s.yawRateDeg=parseFloat((d("autoYawRate")||{value:String(s.yawRateDeg)}).value)}catch{}}const U=d("autoYaw");U&&U.addEventListener("change",()=>{s.yawEnabled&&!s.enabled?A():f()});const k=()=>{s.enabled&&C()};d("randBtn").addEventListener("click",()=>{setTimeout(k,0)});try{te.addEventListener("message",r=>{(r.data||{}).type==="randomizePositions"&&setTimeout(k,0)})}catch{}try{const r=p&&p.setSource?p.setSource.bind(p):null;r&&(p.setSource=(h,o)=>{r(h,o),k()})}catch{}ie(),s.enabled?T():s.yawEnabled&&A()}function re(){const l=d("bypass").checked;try{window.opener&&window.opener._mixerApi&&typeof window.opener._mixerApi.muteMainStereo=="function"&&window.opener._mixerApi.muteMainStereo(!l)}catch{}try{p&&typeof p.setBypass=="function"&&p.setBypass(l)}catch{}}async function be(){const l=async()=>{try{if(window.opener&&window.opener._mixerApi&&!p){$=window.opener._mixerApi.getContext();const t=window.opener._mixerApi.getNode(),e=window.opener._mixerApi.getMasterOut();p=await K.create($,t,e),p.setMeterSink(n=>{const a=Array.from(document.querySelectorAll("#meters .sp-meter > div"));for(let i=0;i<7;i+=1){const c=20*Math.log10(Math.max(1e-6,n[i])),s=Math.max(0,Math.min(1,(c+60)/60));a[i].style.height=String(Math.round(s*100))+"%"}});try{const n=parseFloat((d("rvWet")||{value:"0.05"}).value),a=parseFloat((d("rvDecay")||{value:"1.5"}).value),i=parseFloat((d("rvGainDb")||{value:"0"}).value),c=parseFloat((d("rvHf")||{value:"6000"}).value);p.setReverbParams({wet:n,decayTime:a,gainDb:i,hfDampHz:c});try{p.setReverbScale(5,parseFloat((d("rvScale6")||{value:"1"}).value))}catch{}try{p.setReverbScale(6,parseFloat((d("rvScale7")||{value:"1"}).value))}catch{}}catch{}d("bypass").checked=!1,re();try{const n=p.setSource.bind(p);p.setSource=(a,i)=>{n(a,i);try{E&&E.updateSource(a,p.sources[a])}catch{}}}catch{}try{for(let a=0;a<7;a+=1)E&&E.updateSource(a,p.sources[a]);const n=se();E&&E.updateListener(n)}catch{}}}catch{}};if(await l(),!p){const t=setInterval(async()=>{window.opener&&window.opener._mixerApi&&!p&&(clearInterval(t),await l())},500)}}d("openBtn").addEventListener("click",()=>{});d("randBtn").addEventListener("click",()=>{const l=parseFloat((d("maxDistance")||{value:"10"}).value);p&&p.randomizePositions({radius:l})});d("bypass").addEventListener("change",re);const ee=document.getElementById("floatingRandomizeBtn");ee&&ee.addEventListener("click",()=>{try{window.opener&&window.opener.document.getElementById("randomizeBtn")?.click()}catch{}try{const l=parseFloat((document.getElementById("maxDistance")||{value:"10"}).value);p&&p.randomizePositions({radius:l})}catch{}});fe();try{pe(),ae()}catch{}ye();try{E=me(document.getElementById("spViewport"))}catch{}be();
