(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&l(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function l(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();class J extends AudioWorkletNode{static async create(t){try{await t.audioWorklet.addModule("resonator-processor.js")}catch{}return new J(t)}constructor(t){super(t,"resonator-processor",{numberOfInputs:0,numberOfOutputs:10,outputChannelCount:[2,2,1,1,1,1,1,1,1,1],parameterData:{nbranches:4,noiseLevel:.03,noiseType:1,lfoEnabled:1,lfoRate:.1,lfoDepth:.7,lfoWave:0,rmix:1,quantize:0,exciterCutoff:4e3,exciterHP:50,rainEnabled:1,rainGain:.62,rainRate:.83,rainDurMs:61,rainSpread:.71,rainCenter:.49,rainLimbs:10,monitorExciter:0,groupEnabled:0,groupSplit:0,octaves:0,freqScale:1,freqCenter:0,decayScale:1,exciterBandQNoise:30,exciterBandQRain:30}})}getBranchOutput(t){if(t<0||t>7)throw new Error("branch index out of range (0..7)");return 2+t}get nbranches(){return this.parameters.get("nbranches")}get noiseLevel(){return this.parameters.get("noiseLevel")}get noiseType(){return this.parameters.get("noiseType")}get lfoEnabled(){return this.parameters.get("lfoEnabled")}get lfoRate(){return this.parameters.get("lfoRate")}get lfoDepth(){return this.parameters.get("lfoDepth")}get lfoWave(){return this.parameters.get("lfoWave")}get rmix(){return this.parameters.get("rmix")}get quantize(){return this.parameters.get("quantize")}get exciterCutoff(){return this.parameters.get("exciterCutoff")}get exciterHP(){return this.parameters.get("exciterHP")}get groupEnabled(){return this.parameters.get("groupEnabled")}get groupSplit(){return this.parameters.get("groupSplit")}get octaves(){return this.parameters.get("octaves")}get rainEnabled(){return this.parameters.get("rainEnabled")}get rainGain(){return this.parameters.get("rainGain")}get rainRate(){return this.parameters.get("rainRate")}get rainDurMs(){return this.parameters.get("rainDurMs")}get rainSpread(){return this.parameters.get("rainSpread")}get rainCenter(){return this.parameters.get("rainCenter")}get rainLimbs(){return this.parameters.get("rainLimbs")}get monitorExciter(){return this.parameters.get("monitorExciter")}get freqScale(){return this.parameters.get("freqScale")}get freqCenter(){return this.parameters.get("freqCenter")}get decayScale(){return this.parameters.get("decayScale")}get exciterBandQNoise(){return this.parameters.get("exciterBandQNoise")}get exciterBandQRain(){return this.parameters.get("exciterBandQRain")}setBranchParams(t,{freq:n,decay:l,amp:o,pan:r}){this.port.postMessage({type:"setBranchParams",index:t,params:{freq:n,decay:l,amp:o,pan:r}})}setAllBranches(t){this.port.postMessage({type:"setAllBranches",branches:t})}setScale({name:t,root:n}){this.port.postMessage({type:"setScale",name:t,root:n})}}let p=null,a=null;const R=40;let N=0;const K=["noiseLevel","noiseType","lfoEnabled","lfoRate","lfoDepth","lfoWave","exciterCutoff","exciterHP","exciterBandQNoise","exciterBandQRain","monitorExciter","rainEnabled","rainGain","rainRate","rainDurMs","rainSpread","rainCenter","rainLimbs"];let W=!1,A=null;function G(e){return document.getElementById(e)}const P="uiStateV1",z="exciterStateV1";function H(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch{return null}}function se(e,t){try{localStorage.setItem(e,JSON.stringify(t||{}))}catch{}}function ye(e,t,n){if(e)if(e.type==="checkbox")e.checked=!!n,e.dispatchEvent(new Event("change",{bubbles:!0}));else{e.value=String(n);const l=e.tagName==="SELECT"?"change":"input";e.dispatchEvent(new Event(l,{bubbles:!0}))}}const ve=["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupEnabled","groupSplit","scaleRoot","scaleName"];function _(e){const n={...H(P)||{},...e};se(P,n)}function Se(){const e=H(P);if(e)for(const t of ve){if(!(t in e))continue;const n=G(t);n&&ye(n,t,e[t])}}function ce(e){const n={...H(z)||{},...e};se(z,n)}function de(){return H(z)||null}function Be(e,t){if(!a||!p)return;const n=p.currentTime;switch(e){case"noiseLevel":a.noiseLevel&&a.noiseLevel.setValueAtTime(parseFloat(t),n);break;case"noiseType":a.noiseType&&a.noiseType.setValueAtTime(parseInt(t,10),n);break;case"lfoEnabled":a.lfoEnabled&&a.lfoEnabled.setValueAtTime(t?1:0,n);break;case"lfoRate":a.lfoRate&&a.lfoRate.setValueAtTime(parseFloat(t),n);break;case"lfoDepth":a.lfoDepth&&a.lfoDepth.setValueAtTime(parseFloat(t),n);break;case"lfoWave":a.lfoWave&&a.lfoWave.setValueAtTime(parseInt(t,10),n);break;case"exciterCutoff":a.exciterCutoff&&a.exciterCutoff.setValueAtTime(parseFloat(t),n);break;case"exciterHP":a.exciterHP&&a.exciterHP.setValueAtTime(parseFloat(t),n);break;case"exciterBandQNoise":a.exciterBandQNoise&&a.exciterBandQNoise.setValueAtTime(parseFloat(t),n);break;case"exciterBandQRain":a.exciterBandQRain&&a.exciterBandQRain.setValueAtTime(parseFloat(t),n);break;case"monitorExciter":a.monitorExciter&&a.monitorExciter.setValueAtTime(t?1:0,n);break;case"rainEnabled":a.rainEnabled&&a.rainEnabled.setValueAtTime(t?1:0,n);break;case"rainGain":a.rainGain&&a.rainGain.setValueAtTime(parseFloat(t),n);break;case"rainRate":a.rainRate&&a.rainRate.setValueAtTime(parseFloat(t),n);break;case"rainDurMs":a.rainDurMs&&a.rainDurMs.setValueAtTime(parseFloat(t),n);break;case"rainSpread":a.rainSpread&&a.rainSpread.setValueAtTime(parseFloat(t),n);break;case"rainCenter":a.rainCenter&&a.rainCenter.setValueAtTime(parseFloat(t),n);break;case"rainLimbs":a.rainLimbs&&a.rainLimbs.setValueAtTime(parseInt(t,10),n);break}}function Ce(){const e={};for(const t of K){const n=G(t);if(!n){t==="noiseLevel"&&a&&a.noiseLevel&&(e[t]=a.noiseLevel.value);continue}n.type==="checkbox"?e[t]=!!n.checked:e[t]=n.value}return e}function Q(e){if(!A)return;let t=e||Ce();const n=de();n&&(t={...n,...t}),A.postMessage({type:"state",source:"main",state:t,partial:!!e})}function O(e,t){const n=G(e);if(!n){Be(e,t);return}W=!0;try{if(n.type==="checkbox")n.checked=!!t,n.dispatchEvent(new Event("change",{bubbles:!0}));else{n.value=String(t);const l=n.tagName==="SELECT"?"change":"input";n.dispatchEvent(new Event(l,{bubbles:!0}))}}finally{W=!1}ce({[e]:t})}function Ie(){if(!A&&!(typeof BroadcastChannel>"u")){A=new BroadcastChannel("exciter-controls"),A.onmessage=e=>{const t=e.data||{};if(t.source!=="main")if(t.type==="set"&&t.id)O(t.id,t.value);else if(t.type==="setMultiple"&&t.values){const n=Object.entries(t.values);for(const[l,o]of n)O(l,o)}else t.type==="requestState"&&Q()};for(const e of K){const t=G(e);if(!t)continue;const n=()=>{if(W)return;const l=t.type==="checkbox"?!!t.checked:t.value;ce({[e]:l}),Q({[e]:l})};t.addEventListener("input",n),t.addEventListener("change",n)}}}const ue=25,me=8e3;function U(e){const t=ue,n=me,l=Math.min(Math.max(e,t),n);return Math.log(l/t)/Math.log(n/t)}function pe(e){const t=ue,n=me,l=Math.min(Math.max(e,0),1);return t*Math.pow(n/t,l)}function M(e,t){return Math.random()*(t-e)+e}function fe(e){return Math.round(e*100)/100}function ge(e){return Math.max(0,Math.min(1,e))}function $(e,t,n){return n>t?ge((e-t)/(n-t)):0}function ee(e,t,n){const l=ge(e);return t+l*(n-t)}const be="randomizerConfigV1",L=[{id:"rmix",label:"Mix (rmix)",kind:"float",min:0,max:1,step:.001},{id:"nbranches",label:"Branch count",kind:"int",min:1,max:R,step:1},{id:"freqScale",label:"Freq Scale",kind:"float",min:.25,max:4,step:.01},{id:"octaves",label:"Octave Transpose",kind:"int",min:-4,max:2,step:1},{id:"freqCenter",label:"Freq Center (Hz)",kind:"int",min:-2e3,max:2e3,step:1},{id:"decayScale",label:"Decay Scale",kind:"float",min:.25,max:4,step:.01},{id:"groupEnabled",label:"Group Mode",kind:"bool"},{id:"groupSplit",label:"Group Split",kind:"int",min:0,max:R,step:1},{id:"scaleRoot",label:"Scale Root",kind:"select",options:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]},{id:"scaleName",label:"Scale",kind:"select",options:["off","chromatic","major","minor","harmonicMinor","melodicMinor","dorian","phrygian","lydian","mixolydian","locrian","pentatonicMajor","pentatonicMinor","blues","wholeTone","octatonic12","octatonic21"]},{id:"noiseLevel",label:"Noise Level",kind:"float",min:0,max:.5,step:.001},{id:"noiseType",label:"Noise Type",kind:"int",min:0,max:3,step:1},{id:"lfoEnabled",label:"LFO Enable",kind:"bool"},{id:"lfoRate",label:"LFO Rate (Hz)",kind:"float",min:.1,max:20,step:.01},{id:"lfoDepth",label:"LFO Depth",kind:"float",min:0,max:1,step:.01},{id:"lfoWave",label:"LFO Wave",kind:"int",min:0,max:3,step:1},{id:"exciterCutoff",label:"Exciter LP (Hz)",kind:"int",min:50,max:2e4,step:1},{id:"exciterHP",label:"Exciter HP (Hz)",kind:"int",min:10,max:2e3,step:1},{id:"exciterBandQNoise",label:"Exciter Band Q (Noise)",kind:"float",min:.5,max:80,step:.5},{id:"exciterBandQRain",label:"Exciter Band Q (Rain)",kind:"float",min:.5,max:80,step:.5},{id:"monitorExciter",label:"Monitor Exciter Only",kind:"bool"},{id:"rainEnabled",label:"Rain Enabled",kind:"bool"},{id:"rainGain",label:"Rain Gain",kind:"float",min:0,max:1,step:.01},{id:"rainRate",label:"Rain Rate (Hz)",kind:"float",min:.1,max:40,step:.01},{id:"rainDurMs",label:"Drop Duration (ms)",kind:"int",min:1,max:200,step:1},{id:"rainSpread",label:"Spread",kind:"float",min:0,max:1,step:.01},{id:"rainCenter",label:"Center",kind:"float",min:0,max:1,step:.01},{id:"rainLimbs",label:"N Limbs",kind:"int",min:1,max:10,step:1},{id:"noiseLP",label:"Mixer Noise LP (Hz)",kind:"int",min:50,max:2e4,step:1}];function X(){try{const e=localStorage.getItem(be);return e?JSON.parse(e):null}catch{return null}}function V(e){try{localStorage.setItem(be,JSON.stringify(e))}catch{}}function Y(){const e={};for(const t of L){const n={enabled:!1,depEnabled:!1,depTarget:"",depBias:0};t.kind==="bool"||t.kind==="select"?e[t.id]={...n}:e[t.id]={...n,min:t.min,max:t.max,step:t.step}}return e.rmix.enabled=!0,e.rmix.min=.7,e.rmix.max=1,e.rmix.step=.001,e.nbranches.enabled=!0,e.nbranches.min=5,e.nbranches.max=R,e.nbranches.step=1,e.octaves.enabled=!0,e.octaves.min=-2,e.octaves.max=2,e.octaves.step=1,e.decayScale.enabled=!0,e.decayScale.min=.3,e.decayScale.max=4,e.decayScale.step=.01,e.groupEnabled.enabled=!1,e.groupSplit.enabled=!1,e.groupSplit.min=0,e.groupSplit.max=R,e.groupSplit.step=1,e.scaleRoot.enabled=!1,e.scaleName.enabled=!1,e}function Z(e){const t=e?JSON.parse(JSON.stringify(e)):{};for(const n of L){const l={enabled:!1,depEnabled:!1,depTarget:"",depBias:0};let o=t[n.id];if(o||(o=n.kind==="bool"||n.kind==="select"?{...l}:{...l,min:n.min,max:n.max,step:n.step}),n.kind!=="bool"&&n.kind!=="select"){let r=parseFloat(o.min),i=parseFloat(o.max);isNaN(r)&&(r=n.min),isNaN(i)&&(i=n.max),r=Math.max(n.min,Math.min(n.max,r)),i=Math.max(n.min,Math.min(n.max,i)),i>r||(r=n.min,i=n.max),o.min=r,o.max=i,o.step=n.step}t[n.id]={...l,...o}}return t}function Te(){const e=document.getElementById("randomizerPanel");if(!e)return;const t=Z(X()||Y()),n=o=>{const r=document.createElement("div");r.className="rand-card";const i=document.createElement("h3");return i.textContent=o,r.appendChild(i),r},l=[{title:"Main",ids:["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupEnabled","groupSplit","scaleRoot","scaleName"]},{title:"Exciter",ids:["noiseLevel","noiseType","lfoEnabled","lfoRate","lfoDepth","lfoWave","exciterCutoff","exciterHP","exciterBandQNoise","exciterBandQRain","monitorExciter","rainEnabled","rainGain","rainRate","rainDurMs","rainSpread","rainCenter","rainLimbs"]},{title:"Mixer",ids:["noiseLP"]}];e.innerHTML="";for(const o of l){const r=n(o.title);for(const i of o.ids){const c=L.find(s=>s.id===i);if(!c)continue;const u=document.createElement("div");u.className="rand-row";const f=document.createElement("input");f.type="checkbox",f.checked=!!(t[i]&&t[i].enabled),f.addEventListener("change",()=>{t[i]=t[i]||{},t[i].enabled=!!f.checked,V(t)}),u.appendChild(f);const h=document.createElement("div");if(c.kind==="bool"||c.kind==="select"){const s=document.createElement("label");s.textContent=c.label+(c.kind==="select"?" (random pick)":""),h.appendChild(s)}else{const s=document.createElement("label");s.textContent=c.label,h.appendChild(s);const d=document.createElement("div");d.className="range";const E=document.createElement("input");E.type="number",E.step=String(c.step||1),E.value=String((t[i]&&t[i].min)!=null?t[i].min:c.min);const v=document.createElement("input");v.type="number",v.step=String(c.step||1),v.value=String((t[i]&&t[i].max)!=null?t[i].max:c.max);const F=()=>{const w=parseFloat(E.value),D=parseFloat(v.value);t[i]||(t[i]={enabled:!1}),t[i].min=isNaN(w)?c.min:w,t[i].max=isNaN(D)?c.max:D,t[i].step=c.step,V(t)};E.addEventListener("input",F),v.addEventListener("input",F),d.appendChild(E),d.appendChild(v),h.appendChild(d)}const b=document.createElement("div");b.className="dep";const g=document.createElement("input");g.type="checkbox",g.checked=!!(t[i]&&t[i].depEnabled),g.title="Enable dependency";const S=document.createElement("span");S.textContent="Dependency";const x=document.createElement("select"),B=document.createElement("option");B.value="",B.textContent="(choose target)",x.appendChild(B);for(const s of L){if(s.id===i)continue;const d=document.createElement("option");d.value=s.id,d.textContent=s.label,x.appendChild(d)}x.value=t[i]&&t[i].depTarget||"";const C=document.createElement("div");C.className="bias";const I=document.createElement("span");I.textContent="Bias";const y=document.createElement("input");y.type="range",y.min="-1",y.max="1",y.step="0.01",y.value=String(t[i]&&typeof t[i].depBias=="number"?t[i].depBias:0);const T=document.createElement("span"),m=()=>{T.textContent=String(Math.round(parseFloat(y.value)*100))+"%"};m(),y.addEventListener("input",()=>{m(),t[i]||(t[i]={enabled:!1}),t[i].depBias=parseFloat(y.value),V(t)}),g.addEventListener("change",()=>{t[i]=t[i]||{},t[i].depEnabled=!!g.checked,V(t)}),x.addEventListener("change",()=>{t[i]=t[i]||{},t[i].depTarget=x.value,V(t)}),b.appendChild(g),b.appendChild(S),b.appendChild(x),C.appendChild(I),C.appendChild(y),C.appendChild(T),b.appendChild(C),h.appendChild(b),u.appendChild(h),r.appendChild(u)}e.appendChild(r)}}function ke(e,t){if(!t||!t.enabled)return null;if(e.kind==="bool")return Math.random()<.5;if(e.kind==="select"){const r=e.options||[];return r.length?r[Math.floor(Math.random()*r.length)]:null}const n=parseFloat(t.min),l=parseFloat(t.max);if(!(l>n))return null;let o=M(n,l);if(e.kind==="int"&&(o=Math.round(o)),e.step){const r=e.step;o=Math.round(o/r)*r}return o}function Me(){const e=Z(X()||Y()),t=[...L];t.sort((r,i)=>r.id==="nbranches"?-1:i.id==="nbranches"?1:0);const n={};for(const r of t){const i=ke(r,e[r.id]);i!=null&&(n[r.id]=i)}if(n.groupSplit!=null){const r=n.nbranches!=null?n.nbranches:document.getElementById("nbranches")?parseInt(document.getElementById("nbranches").value,10):null;r!=null&&(n.groupSplit=Math.max(0,Math.min(r,n.groupSplit|0)))}const l=Object.fromEntries(L.map(r=>[r.id,r]));for(const r of Object.keys(e)){const i=e[r];if(!i||!i.depEnabled)continue;const c=i.depTarget;if(!c||c===r||n[r]==null||n[c]==null)continue;const u=l[r],f=l[c];if(!u||!f)continue;const h=e[r],b=e[c],g=u.kind==="bool"||u.kind==="select"?0:h&&h.min!=null?h.min:u.min,S=u.kind==="bool"||u.kind==="select"?1:h&&h.max!=null?h.max:u.max,x=f.kind==="bool"||f.kind==="select"?0:b&&b.min!=null?b.min:f.min,B=f.kind==="bool"||f.kind==="select"?1:b&&b.max!=null?b.max:f.max,C=$(n[r],g,S),I=typeof i.depBias=="number"?Math.max(-1,Math.min(1,i.depBias)):0,y=Math.abs(I),T=$(n[c],x,B),m=I<0?0:1,s=y*C,d=T+(m-T)*s;n[c]=f.kind==="bool"?d>=.5:f.kind==="int"?Math.round(ee(d,x,B)):ee(d,x,B)}const o=Object.entries(n);for(const[r,i]of o)r!=="noiseLP"&&O(r,i);if(n.noiseLP!=null){if(window._mixerApi&&typeof window._mixerApi.setNoiseLP=="function")try{window._mixerApi.setNoiseLP(n.noiseLP)}catch{}try{typeof BroadcastChannel<"u"&&new BroadcastChannel("mixer").postMessage({type:"setNoiseLP",value:n.noiseLP})}catch{}}try{if(A){const r={};for(const i of K)n[i]!=null&&(r[i]=n[i]);Object.keys(r).length&&A.postMessage({type:"setMultiple",values:r,source:"main"})}}catch{}document.getElementById("rmix")&&q()}function Ae(e){const t=document.createElement("div");t.className="grid row",t.dataset.index=String(e);const n=document.createElement("span");n.textContent=String(e+1),t.appendChild(n);const l=document.createElement("input");l.type="range",l.min="0",l.max="1",l.step="0.001",l.value=String(U(440)),l.dataset.role="freq",t.appendChild(l);const o=document.createElement("input");o.type="range",o.min="50",o.max="3000",o.step="1",o.value="400",o.dataset.role="decay",t.appendChild(o);const r=document.createElement("input");r.type="range",r.min="0",r.max="1",r.step="0.001",r.value="0.2",r.dataset.role="amp",t.appendChild(r);const i=document.createElement("input");i.type="range",i.min="-1",i.max="1",i.step="0.001",i.value="0",i.dataset.role="pan",t.appendChild(i);const c=()=>{if(!a)return;const u={freq:pe(parseFloat(l.value)),decay:parseFloat(o.value),amp:parseFloat(r.value),pan:parseFloat(i.value)};a.setBranchParams(e,u)};return l.addEventListener("input",c),o.addEventListener("input",c),r.addEventListener("input",c),i.addEventListener("input",c),t}function j(e){document.querySelectorAll("#branches .row").forEach((n,l)=>{n.style.display=l<e?"grid":"none"})}function Re(e){const t=[],n=document.querySelectorAll("#branches .row");for(let l=0;l<e;l+=1){const o=Math.round(M(100,2e3)),r=Math.round(M(100,800)),i=fe(M(.005,.05)),c=M(-1,1);t.push({freq:o,decay:r,amp:i,pan:c});const u=n[l];u.querySelector('input[data-role="freq"]').value=String(U(o)),u.querySelector('input[data-role="decay"]').value=String(r),u.querySelector('input[data-role="amp"]').value=String(i),u.querySelector('input[data-role="pan"]').value=String(c)}a&&a.setAllBranches(t)}function Le(e,t){const n=document.querySelectorAll("#branches .row"),l=Math.max(0,e|0),o=Math.min(R,t|0);for(let r=l;r<o;r+=1){const i=Math.round(M(100,2e3)),c=Math.round(M(100,800)),u=fe(M(.005,.05)),f=M(-1,1),h=n[r];if(!h)continue;const b=h.querySelector('input[data-role="freq"]'),g=h.querySelector('input[data-role="decay"]'),S=h.querySelector('input[data-role="amp"]'),x=h.querySelector('input[data-role="pan"]');b&&(b.value=String(U(i))),g&&(g.value=String(c)),S&&(S.value=String(u)),x&&(x.value=String(f)),a&&a.setBranchParams(r,{freq:i,decay:c,amp:u,pan:f})}}function he(){const e=parseInt(document.getElementById("nbranches").value,10)||4,t=document.querySelectorAll("#branches .row"),n=[];for(let l=0;l<e;l+=1){const o=t[l],r=parseFloat(o.querySelector('input[data-role="freq"]').value),i=parseFloat(o.querySelector('input[data-role="decay"]').value),c=parseFloat(o.querySelector('input[data-role="pan"]').value),u=o.querySelector('input[data-role="amp"]');u&&(u.value="0.2"),n.push({freq:pe(r),decay:i,amp:.2,pan:c})}a&&a.setAllBranches(n),q()}function q(){const e=t=>document.getElementById(t);e("noiseLevel")&&(e("noiseLevelVal").textContent=Number(e("noiseLevel").value).toFixed(2)),e("rmixVal").textContent=Number(e("rmix").value).toFixed(2),e("nbranchesVal").textContent=e("nbranches").value,e("freqScaleVal").textContent=Number(e("freqScale").value).toFixed(2),e("octaves")&&(e("octavesVal").textContent=String(parseInt(e("octaves").value,10))),e("burstRate")&&(e("burstRateVal").textContent=Number(e("burstRate").value).toFixed(2)),e("burstDurMs")&&(e("burstDurMsVal").textContent=e("burstDurMs").value),e("impulseGain")&&(e("impulseGainVal").textContent=Number(e("impulseGain").value).toFixed(2)),e("exciterHP")&&(e("exciterHPVal").textContent=e("exciterHP").value),e("freqCenterVal").textContent=e("freqCenter").value,e("decayScaleVal").textContent=Number(e("decayScale").value).toFixed(2),e("groupSplit")&&(e("groupSplitVal").textContent=String(parseInt(e("groupSplit").value,10))),e("exciterBandQNoise")&&(e("exciterBandQNoiseVal").textContent=e("exciterBandQNoise").value),e("exciterBandQRain")&&(e("exciterBandQRainVal").textContent=e("exciterBandQRain").value),e("rainRate")&&(e("rainRateVal").textContent=Number(e("rainRate").value).toFixed(2)),e("rainDurMs")&&(e("rainDurMsVal").textContent=e("rainDurMs").value),e("rainGain")&&(e("rainGainVal").textContent=Number(e("rainGain").value).toFixed(2)),e("rainSpread")&&(e("rainSpreadVal").textContent=Number(e("rainSpread").value).toFixed(2)),e("rainCenter")&&(e("rainCenterVal").textContent=Number(e("rainCenter").value).toFixed(2)),e("rainLimbs")&&(e("rainLimbsVal").textContent=e("rainLimbs").value)}async function Ve(){if(p)return;p=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100,latencyHint:"playback"}),a=await J.create(p);const e=p.createGain();e.gain.value=1;const t=p.createGain();t.gain.value=1;const n=p.createBiquadFilter();n.type="lowpass",n.frequency.value=2e4,a.connect(n,0,0),n.connect(e),a.connect(t,1,0),e.connect(p.destination),t.connect(p.destination);const l=p.createAnalyser();l.fftSize=1024;const o=p.createAnalyser();o.fftSize=1024,e.connect(l),t.connect(o);const r=new Float32Array(l.fftSize),i=new Float32Array(o.fftSize),c=()=>{const m=document.getElementById("meter0Bar"),s=document.getElementById("meter1Bar");if(m&&s){l.getFloatTimeDomainData(r),o.getFloatTimeDomainData(i);let d=0;for(let k=0;k<r.length;k+=1)d+=r[k]*r[k];let E=0;for(let k=0;k<i.length;k+=1)E+=i[k]*i[k];const v=Math.sqrt(d/r.length),F=Math.sqrt(E/i.length),w=20*Math.log10(Math.max(1e-6,v)),D=20*Math.log10(Math.max(1e-6,F)),Ee=Math.max(0,Math.min(1,(w+60)/60)),xe=Math.max(0,Math.min(1,(D+60)/60));m.style.height=String(Math.round(Ee*100))+"%",s.style.height=String(Math.round(xe*100))+"%"}requestAnimationFrame(c)};requestAnimationFrame(c),window._mixerApi={setNoiseLP(m){n.frequency.setTargetAtTime(Math.max(50,Math.min(2e4,m||2e4)),p.currentTime,.02)},getNoiseLP:()=>n.frequency.value,getContext:()=>p,getNode:()=>a},console.info("AudioContext started",{sampleRate:p.sampleRate,baseLatency:p.baseLatency});const u=m=>document.getElementById(m),f=["rmix","nbranches","freqScale","octaves","freqCenter","decayScale","groupSplit"],h=["noiseType","lfoRate","lfoDepth","exciterCutoff","exciterHP","exciterBandQNoise","exciterBandQRain","rainRate","rainDurMs","rainGain","rainSpread","rainCenter","rainLimbs"];for(const m of h)document.getElementById(m)&&f.push(m);if(f.forEach(m=>{const s=u(m);s&&s.addEventListener("input",()=>{if(q(),_({[m]:s.type==="checkbox"?!!s.checked:m==="nbranches"||m==="octaves"||m==="groupSplit"?parseInt(s.value,10):parseFloat(s.value)}),!a)return;const d=p.currentTime;switch(m){case"noiseLevel":a.noiseLevel.setValueAtTime(parseFloat(s.value),d);break;case"noiseType":a.noiseType.setValueAtTime(parseInt(s.value,10),d);break;case"rmix":a.rmix.setValueAtTime(parseFloat(s.value),d);break;case"nbranches":{const E=parseInt(s.value,10);a.nbranches.setValueAtTime(E,d),j(E);const v=document.getElementById("groupSplit");v&&(v.max=String(E),parseInt(v.value,10)>E&&(v.value=String(E))),E>N&&Le(N,E),N=E;break}case"freqScale":a.freqScale.setValueAtTime(parseFloat(s.value),d);break;case"octaves":a.octaves.setValueAtTime(parseInt(s.value,10),d);break;case"exciterCutoff":a.exciterCutoff.setValueAtTime(parseFloat(s.value),d);break;case"exciterHP":a.exciterHP.setValueAtTime(parseFloat(s.value),d);break;case"burstRate":a.burstRate.setValueAtTime(parseFloat(s.value),d);break;case"burstDurMs":a.burstDurMs.setValueAtTime(parseFloat(s.value),d);break;case"impulseGain":a.impulseGain.setValueAtTime(parseFloat(s.value),d);break;case"freqCenter":a.freqCenter.setValueAtTime(parseFloat(s.value),d);break;case"decayScale":a.decayScale.setValueAtTime(parseFloat(s.value),d);break;case"exciterBandQNoise":a.exciterBandQNoise.setValueAtTime(parseFloat(s.value),d);break;case"exciterBandQRain":a.exciterBandQRain.setValueAtTime(parseFloat(s.value),d);break;case"groupSplit":a.groupSplit.setValueAtTime(parseInt(s.value,10),d);break}})}),typeof BroadcastChannel<"u"){const m=new BroadcastChannel("mixer");m.onmessage=s=>{const d=s.data||{};if(d.type==="setNoiseLP"&&typeof d.value=="number")try{n.frequency.setTargetAtTime(Math.max(50,Math.min(2e4,d.value)),p.currentTime,.02)}catch{}}}const b=document.getElementById("groupEnabled");b&&b.addEventListener("change",()=>{a&&(_({groupEnabled:!!b.checked}),a.groupEnabled.setValueAtTime(b.checked?1:0,p.currentTime))});const g=document.getElementById("rainEnabled");g&&g.addEventListener("change",()=>{a&&a.rainEnabled.setValueAtTime(g.checked?1:0,p.currentTime)});const S=document.getElementById("lfoEnabled");S&&S.addEventListener("change",()=>{a&&a.lfoEnabled.setValueAtTime(S.checked?1:0,p.currentTime)});const x=document.getElementById("lfoWave");x&&x.addEventListener("change",()=>{a&&a.lfoWave.setValueAtTime(parseInt(x.value,10),p.currentTime)});const B=document.getElementById("monitorExciter");B&&B.addEventListener("change",()=>{a&&a.monitorExciter.setValueAtTime(B.checked?1:0,p.currentTime)});const C=document.getElementById("scaleRoot"),I=document.getElementById("scaleName"),y=()=>{if(!a)return;const m=I.value,s=C.value;_({scaleName:m,scaleRoot:s}),a.setScale({name:m,root:s}),a.quantize.setValueAtTime(m==="off"?0:1,p.currentTime)};C.addEventListener("change",y),I.addEventListener("change",y);const T=parseInt(document.getElementById("nbranches").value,10)||16;a.nbranches.setValueAtTime(T,p.currentTime),j(T),N=T,(function(){C&&I&&y()})(),he(),Q()}const te=document.getElementById("branches");if(te)for(let e=0;e<R;e+=1)te.appendChild(Ae(e));const ne=document.getElementById("startBtn");ne&&ne.addEventListener("click",Ve);const ae=document.getElementById("randomizeBtn");ae&&ae.addEventListener("click",()=>{const e=parseInt(document.getElementById("nbranches").value,10)||16;Me();const t=parseInt(document.getElementById("nbranches").value,10)||e;Re(t);const n=document.getElementById("scaleRoot"),l=document.getElementById("scaleName"),o=Z(X()||Y());if(!(o.scaleRoot&&o.scaleRoot.enabled||o.scaleName&&o.scaleName.enabled)&&n&&l){const i=Array.from(n.options).map(g=>g.value),c=Array.from(l.options).map(g=>g.value),u=c.filter(g=>g!=="off"),f=g=>g[Math.floor(Math.random()*g.length)],h=f(i),b=f(u.length?u:c);n.value=h,l.value=b,n.dispatchEvent(new Event("change",{bubbles:!0})),l.dispatchEvent(new Event("change",{bubbles:!0}))}});const re=document.getElementById("resetBtn");re&&re.addEventListener("click",()=>{try{localStorage.removeItem(P),localStorage.removeItem(z)}catch{}document.getElementById("noiseLevel")&&(document.getElementById("noiseLevel").value="0.03"),document.getElementById("rmix").value="1",document.getElementById("nbranches").value="4",document.getElementById("freqScale").value="1",document.getElementById("octaves").value="0",document.getElementById("exciterCutoff")&&(document.getElementById("exciterCutoff").value="4000"),document.getElementById("exciterHP")&&(document.getElementById("exciterHP").value="50"),document.getElementById("noiseType")&&(document.getElementById("noiseType").value="0"),document.getElementById("lfoEnabled")&&(document.getElementById("lfoEnabled").checked=!0),document.getElementById("lfoRate")&&(document.getElementById("lfoRate").value="0.10"),document.getElementById("lfoDepth")&&(document.getElementById("lfoDepth").value="0.56"),document.getElementById("lfoWave")&&(document.getElementById("lfoWave").value="0"),document.getElementById("rainEnabled")&&(document.getElementById("rainEnabled").checked=!0),document.getElementById("rainRate")&&(document.getElementById("rainRate").value="0.81"),document.getElementById("rainDurMs")&&(document.getElementById("rainDurMs").value="8"),document.getElementById("rainGain")&&(document.getElementById("rainGain").value="0.85"),document.getElementById("rainSpread")&&(document.getElementById("rainSpread").value="0.69"),document.getElementById("rainCenter")&&(document.getElementById("rainCenter").value="0.55"),document.getElementById("rainLimbs")&&(document.getElementById("rainLimbs").value="9"),document.getElementById("monitorExciter")&&(document.getElementById("monitorExciter").checked=!1),document.getElementById("freqCenter").value="0",document.getElementById("decayScale").value="1",document.getElementById("groupEnabled")&&(document.getElementById("groupEnabled").checked=!1),document.getElementById("groupSplit")&&(document.getElementById("groupSplit").value="0");const e=document.getElementById("exciterBandQNoise");e&&(e.value="30");const t=document.getElementById("exciterBandQRain");if(t&&(t.value="30"),document.getElementById("scaleRoot")&&(document.getElementById("scaleRoot").value="A"),document.getElementById("scaleName")&&(document.getElementById("scaleName").value="off"),q(),a&&p){const n=p.currentTime;a.noiseLevel.setValueAtTime(.03,n),a.noiseType&&a.noiseType.setValueAtTime(1,n),a.lfoEnabled&&a.lfoEnabled.setValueAtTime(1,n),a.lfoRate&&a.lfoRate.setValueAtTime(.1,n),a.lfoDepth&&a.lfoDepth.setValueAtTime(.56,n),a.lfoWave&&a.lfoWave.setValueAtTime(0,n),a.rmix.setValueAtTime(1,n),a.nbranches.setValueAtTime(4,n),a.freqScale.setValueAtTime(1,n),a.octaves.setValueAtTime(0,n),a.exciterCutoff&&a.exciterCutoff.setValueAtTime(4e3,n),a.exciterHP&&a.exciterHP.setValueAtTime(50,n),a.rainEnabled&&a.rainEnabled.setValueAtTime(1,n),a.rainRate&&a.rainRate.setValueAtTime(.83,n),a.rainDurMs&&a.rainDurMs.setValueAtTime(61,n),a.rainGain&&a.rainGain.setValueAtTime(.62,n),a.rainSpread&&a.rainSpread.setValueAtTime(.71,n),a.rainCenter&&a.rainCenter.setValueAtTime(.49,n),a.rainLimbs&&a.rainLimbs.setValueAtTime(10,n),a.monitorExciter&&a.monitorExciter.setValueAtTime(0,n),a.freqCenter.setValueAtTime(0,n),a.decayScale.setValueAtTime(1,n),a.groupEnabled&&a.groupEnabled.setValueAtTime(0,n),a.groupSplit&&a.groupSplit.setValueAtTime(0,n),a.quantize.setValueAtTime(0,n),a.setScale&&a.setScale({name:"off",root:"A"}),j(4),N=4}he(),Q()});document.getElementById("rmix")&&q();Ie();const ie=document.getElementById("openControlsBtn");ie&&ie.addEventListener("click",()=>{window.open("control.html","Exciter Controls")});const oe=document.getElementById("openMixerBtn");oe&&oe.addEventListener("click",()=>{window.open("mixer.html","Mixer")});const le=document.getElementById("openRandomizerBtn");le&&le.addEventListener("click",()=>{window.open("randomizer.html","Randomizer")});document.getElementById("randomizerPanel")&&Te();(function(){try{Se()}catch{}try{const t=de();if(t)for(const[n,l]of Object.entries(t))O(n,l)}catch{}})();
